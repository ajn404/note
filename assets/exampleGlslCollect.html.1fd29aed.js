import{_ as c,b as l,o as i,c as u,H as p,e as s,q as a,a as o,w as e}from"./app.28a7effe.js";const k={},r={id:"ed209",tabindex:"-1"},d={id:"fractalcity",tabindex:"-1"},m={id:"lightsaberduel",tabindex:"-1"},v={id:"primitives",tabindex:"-1"},b={id:"simpletruchetpattern",tabindex:"-1"},f={id:"waveprint",tabindex:"-1"};function y(w,n){const t=l("RouterLink");return i(),u("div",null,[n[18]||(n[18]=p(`<div class="custom-container tip"><p class="custom-container-title">\u8FD9\u91CC\u53EA\u5C55\u5F00fragment.glsl\u7684\u4EE3\u7801,vertex\u90FD\u5927\u5DEE\u4E0D\u79BB</p></div><div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_position<span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> vUv<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vUv <span class="token operator">=</span> uv<span class="token punctuation">;</span>
    v_position <span class="token operator">=</span> position<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> projectionMatrix <span class="token operator">*</span> modelViewMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>position<span class="token operator">*</span><span class="token number">0.4</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2)),s("h3",r,[n[1]||(n[1]=s("a",{class:"header-anchor",href:"#ed209","aria-hidden":"true"},"#",-1)),n[2]||(n[2]=a()),o(t,{to:"/markdown/example/ed209.html"},{default:e(()=>n[0]||(n[0]=[a("ed209")])),_:1})]),n[19]||(n[19]=p(`<div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_resolution<span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> vUv<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_time<span class="token punctuation">;</span>


<span class="token keyword">float</span> stretch<span class="token punctuation">,</span> gunsUp<span class="token punctuation">,</span> gunsForward<span class="token punctuation">,</span> edWalk<span class="token punctuation">,</span> edTwist<span class="token punctuation">,</span> edDown<span class="token punctuation">,</span> edShoot<span class="token punctuation">,</span> doorOpen<span class="token punctuation">,</span> glow <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

<span class="token comment">// #define AA  // Enable this line if your GPU can take it!</span>

<span class="token keyword">struct</span> <span class="token class-name">MarchData</span> <span class="token punctuation">{</span>
	<span class="token keyword">float</span> d<span class="token punctuation">;</span>
	<span class="token keyword">vec3</span> mat<span class="token punctuation">;</span> <span class="token comment">// RGB</span>
	<span class="token keyword">float</span> specPower<span class="token punctuation">;</span> <span class="token comment">// 0: None, 30.0: Shiny</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">mat2</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token keyword">float</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">float</span> c <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span>
	      s <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">mat2</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">remap</span><span class="token punctuation">(</span><span class="token keyword">float</span> f<span class="token punctuation">,</span> <span class="token keyword">float</span> in1<span class="token punctuation">,</span> <span class="token keyword">float</span> in2<span class="token punctuation">,</span> <span class="token keyword">float</span> out1<span class="token punctuation">,</span> <span class="token keyword">float</span> out2<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">mix</span><span class="token punctuation">(</span>out1<span class="token punctuation">,</span> out2<span class="token punctuation">,</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">-</span> in1<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>in2 <span class="token operator">-</span> in1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdBox</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">vec3</span> q <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> b<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>y<span class="token punctuation">,</span> q<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdChamferedCube</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> r<span class="token punctuation">,</span> <span class="token keyword">float</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">float</span> cube <span class="token operator">=</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>xz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token number">.78525</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>xz <span class="token operator">*=</span> <span class="token operator">-</span>c <span class="token operator">/</span> <span class="token number">1.41</span> <span class="token operator">+</span> <span class="token number">1.41</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">max</span><span class="token punctuation">(</span>cube<span class="token punctuation">,</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdTriPrism</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec2</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">vec3</span> q <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>z <span class="token operator">-</span> h<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">.866025</span> <span class="token operator">+</span> p<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">,</span> <span class="token operator">-</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">-</span> h<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdCappedCone</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> a<span class="token punctuation">,</span> <span class="token keyword">vec3</span> b<span class="token punctuation">,</span> <span class="token keyword">float</span> ra<span class="token punctuation">,</span> <span class="token keyword">float</span> rb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">float</span> rba <span class="token operator">=</span> rb <span class="token operator">-</span> ra<span class="token punctuation">,</span>
	      baba <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>b <span class="token operator">-</span> a<span class="token punctuation">,</span> b <span class="token operator">-</span> a<span class="token punctuation">)</span><span class="token punctuation">,</span>
	      papa <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>p <span class="token operator">-</span> a<span class="token punctuation">,</span> p <span class="token operator">-</span> a<span class="token punctuation">)</span><span class="token punctuation">,</span>
	      paba <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>p <span class="token operator">-</span> a<span class="token punctuation">,</span> b <span class="token operator">-</span> a<span class="token punctuation">)</span> <span class="token operator">/</span> baba<span class="token punctuation">,</span>
	      x <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>papa <span class="token operator">-</span> paba <span class="token operator">*</span> paba <span class="token operator">*</span> baba<span class="token punctuation">)</span><span class="token punctuation">,</span>
	      cax <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> x <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>paba <span class="token operator">&lt;</span> <span class="token number">.5</span><span class="token punctuation">)</span> <span class="token operator">?</span> ra <span class="token operator">:</span> rb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	      cay <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>paba <span class="token operator">-</span> <span class="token number">.5</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.5</span><span class="token punctuation">,</span>
	      f <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rba <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> ra<span class="token punctuation">)</span> <span class="token operator">+</span> paba <span class="token operator">*</span> baba<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>rba <span class="token operator">*</span> rba <span class="token operator">+</span> baba<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	      cbx <span class="token operator">=</span> x <span class="token operator">-</span> ra <span class="token operator">-</span> f <span class="token operator">*</span> rba<span class="token punctuation">,</span>
	      cby <span class="token operator">=</span> paba <span class="token operator">-</span> f<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cbx <span class="token operator">&lt;</span> <span class="token number">0.</span> <span class="token operator">&amp;&amp;</span> cay <span class="token operator">&lt;</span> <span class="token number">0.</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1.</span> <span class="token operator">:</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>cax <span class="token operator">*</span> cax <span class="token operator">+</span> cay <span class="token operator">*</span> cay <span class="token operator">*</span> baba<span class="token punctuation">,</span> cbx <span class="token operator">*</span> cbx <span class="token operator">+</span> cby <span class="token operator">*</span> cby <span class="token operator">*</span> baba<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">float</span> h<span class="token punctuation">,</span> <span class="token keyword">float</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">vec2</span> d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span> d<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdCapsule</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> a<span class="token punctuation">,</span> <span class="token keyword">vec3</span> b<span class="token punctuation">,</span> <span class="token keyword">float</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">vec3</span> pa <span class="token operator">=</span> p <span class="token operator">-</span> a<span class="token punctuation">,</span>
	     ba <span class="token operator">=</span> b <span class="token operator">-</span> a<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>pa <span class="token operator">-</span> ba <span class="token operator">*</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> ba<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">dot</span><span class="token punctuation">(</span>ba<span class="token punctuation">,</span> ba<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdOctogon</span><span class="token punctuation">(</span><span class="token keyword">vec2</span> p<span class="token punctuation">,</span> <span class="token keyword">float</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token keyword">vec3</span> k <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">.92387953</span><span class="token punctuation">,</span> <span class="token number">.38268343</span><span class="token punctuation">,</span> <span class="token number">.41421356</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">-=</span> <span class="token number">2.</span> <span class="token operator">*</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span> <span class="token operator">*</span> k<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
	p <span class="token operator">-=</span> <span class="token number">2.</span> <span class="token operator">*</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>k<span class="token punctuation">.</span>x<span class="token punctuation">,</span> k<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>k<span class="token punctuation">.</span>x<span class="token punctuation">,</span> k<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">-=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">clamp</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">-</span>k<span class="token punctuation">.</span>z <span class="token operator">*</span> r<span class="token punctuation">,</span> k<span class="token punctuation">.</span>z <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sign</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec3</span> <span class="token function">getRayDir</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> ro<span class="token punctuation">,</span> <span class="token keyword">vec3</span> lookAt<span class="token punctuation">,</span> <span class="token keyword">vec2</span> uv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">vec3</span> forward <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lookAt <span class="token operator">-</span> ro<span class="token punctuation">)</span><span class="token punctuation">,</span>
	     right <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> forward<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span>forward <span class="token operator">+</span> right <span class="token operator">*</span> uv<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token function">cross</span><span class="token punctuation">(</span>forward<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">*</span> uv<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

MarchData <span class="token function">minResult</span><span class="token punctuation">(</span>MarchData a<span class="token punctuation">,</span> MarchData b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>d <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>d<span class="token punctuation">)</span> <span class="token keyword">return</span> a<span class="token punctuation">;</span>
	<span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">setBodyMaterial</span><span class="token punctuation">(</span><span class="token keyword">inout</span> MarchData mat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mat<span class="token punctuation">.</span>mat <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.36</span><span class="token punctuation">,</span> <span class="token number">.45</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	mat<span class="token punctuation">.</span>specPower <span class="token operator">=</span> <span class="token number">30.</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">legWalkAngle</span><span class="token punctuation">(</span><span class="token keyword">float</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">sin</span><span class="token punctuation">(</span>edWalk <span class="token operator">*</span> <span class="token number">3.141</span> <span class="token operator">*</span> <span class="token number">6.</span> <span class="token operator">*</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.2</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">mix</span><span class="token punctuation">(</span><span class="token number">5.</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.</span><span class="token punctuation">,</span> edWalk<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">fireShock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>edShoot <span class="token operator">*</span> <span class="token number">78.5375</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">headSphere</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>p <span class="token operator">/</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.8</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

MarchData <span class="token function">headVisor</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">float</span> h<span class="token punctuation">,</span> <span class="token keyword">float</span> bump<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	bump <span class="token operator">*=</span> <span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">150.</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">150.</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.002</span><span class="token punctuation">;</span>
	MarchData result<span class="token punctuation">;</span>
	result<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	result<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">mix</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">headSphere</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.57</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">-</span> bump<span class="token punctuation">;</span>
	result<span class="token punctuation">.</span>mat <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	result<span class="token punctuation">.</span>specPower <span class="token operator">=</span> <span class="token number">30.</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

MarchData <span class="token function">headLower</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">vec3</span> op <span class="token operator">=</span> p<span class="token punctuation">;</span>

	<span class="token comment">// Start by mirroring the visor.</span>
	MarchData r <span class="token operator">=</span> <span class="token function">headVisor</span><span class="token punctuation">(</span>p <span class="token operator">*</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.95</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.4</span><span class="token punctuation">,</span> <span class="token number">.95</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Add the side panels.</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">headVisor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.01</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.95</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>d<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">.35</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">.625</span> <span class="token operator">-</span> p<span class="token punctuation">.</span>z <span class="token operator">-</span> <span class="token number">.66</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// &#39;Wings&#39;.</span>
	p<span class="token punctuation">.</span>xy <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token number">.075</span> <span class="token operator">*</span> <span class="token punctuation">(</span>gunsUp <span class="token operator">-</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sign</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.33</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>y <span class="token operator">-=</span> <span class="token number">.1</span> <span class="token operator">-</span> p<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">.1</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">.06</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.</span> <span class="token operator">-</span> p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.3</span> <span class="token operator">-</span> p<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> op<span class="token punctuation">;</span>

	<span class="token comment">// Cut out a mouth grill.</span>
	p<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">.147</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.0556</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.0278</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">sdBox</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token function">mix</span><span class="token punctuation">(</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">.55</span><span class="token punctuation">,</span> <span class="token operator">-</span>op<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.015</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// &#39;Cheeks&#39;.</span>
	p <span class="token operator">=</span> op<span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">.16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.06</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>z <span class="token operator">-=</span> <span class="token operator">-</span><span class="token number">1.1</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xzy<span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">.03</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xzy<span class="token punctuation">,</span> <span class="token number">.55</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">+</span> <span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setBodyMaterial</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

MarchData <span class="token function">gunPod</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	MarchData r<span class="token punctuation">;</span>
	<span class="token function">setBodyMaterial</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">+=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">.45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Carousel.</span>
	<span class="token keyword">vec3</span> pp <span class="token operator">=</span> p<span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.5</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">sdCappedCone</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.35</span> <span class="token operator">-</span> <span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">.35</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">.4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Triangle nobble.</span>
	pp <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">.28</span> <span class="token operator">-</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">sdTriPrism</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Square outriggers.</span>
	pp <span class="token operator">=</span> p<span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>xy <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token number">.78525</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> fs<span class="token punctuation">,</span>
	      bump <span class="token operator">=</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>z <span class="token operator">*</span> <span class="token number">33.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.003</span><span class="token punctuation">,</span>
	      d <span class="token operator">=</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.1</span> <span class="token operator">-</span> bump<span class="token punctuation">,</span> <span class="token number">.38</span> <span class="token operator">-</span> bump<span class="token punctuation">,</span> <span class="token number">.34</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.02</span><span class="token punctuation">;</span>

	<span class="token comment">// Barrels.</span>
	pp <span class="token operator">=</span> p <span class="token operator">-</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.1</span><span class="token punctuation">;</span>
	d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> <span class="token number">.06</span><span class="token punctuation">,</span> <span class="token number">.15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>pp <span class="token operator">+</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.12</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">.05</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.06</span><span class="token punctuation">,</span> <span class="token number">.05</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.54</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">.06</span><span class="token punctuation">,</span> <span class="token number">.04</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		d <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>pp <span class="token operator">+</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.03</span><span class="token punctuation">,</span> <span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		r<span class="token punctuation">.</span>d <span class="token operator">=</span> d<span class="token punctuation">;</span>
		r<span class="token punctuation">.</span>mat <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Muzzle flash.</span>
	fs <span class="token operator">=</span> <span class="token function">fireShock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fs <span class="token operator">&gt;</span> <span class="token number">.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		d <span class="token operator">=</span> <span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> <span class="token number">.01</span> <span class="token operator">+</span> pp<span class="token punctuation">.</span>z <span class="token operator">*</span> <span class="token number">.05</span><span class="token punctuation">,</span> <span class="token function">fract</span><span class="token punctuation">(</span>fs <span class="token operator">*</span> <span class="token number">3322.423</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.5</span> <span class="token operator">+</span> <span class="token number">.9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span>d <span class="token operator">=</span> d<span class="token punctuation">;</span>
			r<span class="token punctuation">.</span>mat <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			glow <span class="token operator">+=</span> <span class="token number">.1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">.01</span> <span class="token operator">+</span> d <span class="token operator">*</span> d <span class="token operator">*</span> <span class="token number">4e2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

MarchData <span class="token function">arms</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token keyword">vec3</span> wrist <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	MarchData r<span class="token punctuation">;</span>
	<span class="token function">setBodyMaterial</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Position origin.</span>
	p<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">+=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>xy <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token number">.15</span> <span class="token operator">*</span> <span class="token punctuation">(</span>gunsUp <span class="token operator">-</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Shoulder and forearm.</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">sdCapsule</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sdCapsule</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wrist<span class="token punctuation">,</span> <span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Gunz.</span>
	p <span class="token operator">-=</span> wrist<span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>z <span class="token operator">-=</span> gunsForward <span class="token operator">*</span> <span class="token number">.15</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">minResult</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token function">gunPod</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">toe</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">+=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">.32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.3</span> <span class="token operator">+</span> <span class="token number">.2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>z <span class="token operator">-</span> <span class="token number">.18</span><span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">.228</span><span class="token punctuation">,</span> <span class="token number">.3</span> <span class="token operator">+</span> <span class="token number">.2</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>z <span class="token operator">-</span> <span class="token number">.18</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3.69</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.35</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.1</span> <span class="token operator">-</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">foot</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>z <span class="token operator">+=</span> <span class="token number">.8</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token number">.86</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token function">toe</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>xz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token number">1.57</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>x <span class="token operator">-=</span> <span class="token number">.43</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">.25</span> <span class="token operator">-</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token function">toe</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

MarchData <span class="token function">waist</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	MarchData r<span class="token punctuation">;</span>
	<span class="token function">setBodyMaterial</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">.65</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> bump<span class="token punctuation">,</span> d<span class="token punctuation">,</span>
	      legAngle <span class="token operator">=</span> <span class="token function">legWalkAngle</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>xy <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span>legAngle <span class="token operator">*</span> <span class="token number">.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">vec3</span> pp <span class="token operator">=</span> p<span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">.3</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>zyx<span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">.15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Thorax.</span>
	bump <span class="token operator">=</span> <span class="token number">.5</span> <span class="token operator">-</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">40.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.03</span><span class="token punctuation">;</span>
	d <span class="token operator">=</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>bump<span class="token punctuation">,</span> <span class="token number">.15</span><span class="token punctuation">,</span> bump<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Leg joins.</span>
	bump <span class="token operator">=</span> <span class="token number">.3</span> <span class="token operator">-</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">40.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.03</span><span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">.18</span><span class="token punctuation">;</span>
	d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>zyx<span class="token punctuation">,</span> bump<span class="token punctuation">,</span> <span class="token number">.75</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Hips.</span>
	pp<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>yz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">.58525</span> <span class="token operator">+</span> legAngle <span class="token operator">*</span> <span class="token function">sign</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>x <span class="token operator">-=</span> <span class="token number">.98</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>zyx<span class="token punctuation">,</span> <span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">.24</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>pp<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">.14</span> <span class="token operator">+</span> <span class="token number">.2</span> <span class="token operator">*</span> pp<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Thigh pistons.</span>
	p <span class="token operator">=</span> pp<span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>xz <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>xz<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>xzy<span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">.325</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sdCappedCylinder</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>xzy<span class="token punctuation">,</span> <span class="token number">.05</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pp<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// &#39;Knees&#39;.</span>
	p<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">.68</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.04</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.005</span> <span class="token operator">+</span> <span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">.34</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Black segments.</span>
		r<span class="token punctuation">.</span>d <span class="token operator">=</span> d<span class="token punctuation">;</span>
		r<span class="token punctuation">.</span>mat <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

MarchData <span class="token function">legs</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	MarchData r<span class="token punctuation">;</span>
	<span class="token function">setBodyMaterial</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> silver<span class="token punctuation">,</span>
	      legAngle <span class="token operator">=</span> <span class="token function">legWalkAngle</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>z <span class="token operator">+=</span> <span class="token number">.27</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span>legAngle <span class="token operator">*</span> <span class="token function">sign</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>z <span class="token operator">-=</span> <span class="token number">.27</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">.65</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>xy <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span>legAngle <span class="token operator">*</span> <span class="token number">.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">vec3</span> cp<span class="token punctuation">,</span>
	     pp <span class="token operator">=</span> p<span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">.48</span><span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>yz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">.58525</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>x <span class="token operator">-=</span> <span class="token number">.98</span><span class="token punctuation">;</span>
	cp <span class="token operator">=</span> pp<span class="token punctuation">;</span>
	p <span class="token operator">=</span> pp<span class="token punctuation">;</span>
	pp<span class="token punctuation">.</span>xz <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>xz<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token number">.68</span><span class="token punctuation">;</span>

	<span class="token comment">// Thighs.</span>
	p<span class="token punctuation">.</span>xy <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.12</span><span class="token punctuation">;</span>
	silver <span class="token operator">=</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.07</span><span class="token punctuation">,</span> <span class="token number">.05</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Leg end cap.</span>
	cp <span class="token operator">-=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>cp <span class="token operator">-</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1.15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">.07</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.04</span><span class="token punctuation">;</span>

	<span class="token comment">// Shin.</span>
	cp<span class="token punctuation">.</span>z<span class="token operator">++</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">sdChamferedCube</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>xzy<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">.28</span> <span class="token operator">-</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.01</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyx<span class="token punctuation">,</span> <span class="token number">.18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Feet.</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token function">foot</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>silver <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>d <span class="token operator">=</span> silver<span class="token punctuation">;</span>
		r<span class="token punctuation">.</span>mat <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

MarchData <span class="token function">ed209</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">+=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">legWalkAngle</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.2</span> <span class="token operator">+</span> <span class="token number">.1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	MarchData r <span class="token operator">=</span> <span class="token function">legs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> f <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>stretch <span class="token operator">*</span> <span class="token number">2.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	      slide <span class="token operator">=</span> f <span class="token operator">&lt;</span> <span class="token number">.5</span> <span class="token operator">?</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1.</span> <span class="token operator">-</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">-=</span> slide <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">;</span>
	gunsUp <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>stretch <span class="token operator">-</span> <span class="token number">.66</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">6.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0.66-0.83</span>
	gunsForward <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>stretch <span class="token operator">-</span> <span class="token number">.83</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">6.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0.83-1.0</span>
	 <span class="token operator">+</span> <span class="token function">fireShock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">;</span>
	r <span class="token operator">=</span> <span class="token function">minResult</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token function">waist</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token number">.1</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">-</span>edDown <span class="token operator">+</span> <span class="token function">legWalkAngle</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>stretch <span class="token operator">-</span> <span class="token number">.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">6.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0.5-0.66</span>
	p<span class="token punctuation">.</span>xz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span>edTwist <span class="token operator">*</span> <span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">minResult</span><span class="token punctuation">(</span><span class="token function">minResult</span><span class="token punctuation">(</span><span class="token function">minResult</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token function">headLower</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">headVisor</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arms</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

MarchData <span class="token function">room</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token keyword">vec3</span> frameInner <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">2.8</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	MarchData r<span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>mat <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>specPower <span class="token operator">=</span> <span class="token number">1e7</span><span class="token punctuation">;</span>
	<span class="token keyword">vec2</span> xy <span class="token operator">=</span> p<span class="token punctuation">.</span>xy <span class="token operator">-</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>yz <span class="token operator">+=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> doorFrame<span class="token punctuation">,</span> doorWidth<span class="token punctuation">,</span> door<span class="token punctuation">,</span> d<span class="token punctuation">,</span>
	      doorHole <span class="token operator">=</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> frameInner <span class="token operator">+</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	      backWall <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>z <span class="token operator">-</span> <span class="token number">8.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	r<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>backWall<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>doorHole <span class="token operator">+</span> <span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>d <span class="token operator">==</span> backWall<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">float</span> ocp <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">sdOctogon</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">sdOctogon</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token number">1.9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		ocp <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>ocp<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">.7</span> <span class="token operator">-</span> <span class="token function">abs</span><span class="token punctuation">(</span>xy<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>xy<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">sdOctogon</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>xy<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">.7</span> <span class="token operator">-</span> <span class="token function">abs</span><span class="token punctuation">(</span>xy<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ocp <span class="token operator">&lt;</span> <span class="token number">.3</span><span class="token punctuation">)</span> r<span class="token punctuation">.</span>mat <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.39</span><span class="token punctuation">,</span> <span class="token number">.57</span><span class="token punctuation">,</span> <span class="token number">.71</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	doorFrame <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> frameInner <span class="token operator">+</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>doorHole<span class="token punctuation">)</span><span class="token punctuation">;</span>
	doorWidth <span class="token operator">=</span> frameInner<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>x <span class="token operator">-=</span> frameInner<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>xz <span class="token operator">*=</span> <span class="token function">rot</span><span class="token punctuation">(</span>doorOpen <span class="token operator">*</span> <span class="token number">2.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span>x <span class="token operator">+=</span> doorWidth<span class="token punctuation">;</span>
	door <span class="token operator">=</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>doorWidth<span class="token punctuation">,</span> frameInner<span class="token punctuation">.</span>yz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>doorWidth <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">.14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>doorFrame<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>door<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.45</span><span class="token punctuation">,</span> <span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">sdBox</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>d <span class="token operator">=</span> d<span class="token punctuation">;</span>
		r<span class="token punctuation">.</span>mat <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.02</span><span class="token punctuation">,</span> <span class="token number">.02</span><span class="token punctuation">,</span> <span class="token number">.024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		r<span class="token punctuation">.</span>specPower <span class="token operator">=</span> <span class="token number">10.</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Map the scene using SDF functions.</span>
MarchData <span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	MarchData r <span class="token operator">=</span> <span class="token function">minResult</span><span class="token punctuation">(</span><span class="token function">room</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ed209</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> gnd <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">3.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>gnd <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>d <span class="token operator">=</span> gnd<span class="token punctuation">;</span>
		r<span class="token punctuation">.</span>mat <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">calcShadow</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> lightPos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Thanks iq.</span>
	<span class="token keyword">vec3</span> rd <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightPos <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> res <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">,</span>
	      t <span class="token operator">=</span> <span class="token number">.1</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">float</span> i <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30.</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">float</span> h <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">+</span> rd <span class="token operator">*</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span>d<span class="token punctuation">;</span>
		res <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token number">12.</span> <span class="token operator">*</span> h <span class="token operator">/</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
		t <span class="token operator">+=</span> h<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">.001</span> <span class="token operator">||</span> t <span class="token operator">&gt;</span> <span class="token number">25.</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token function">clamp</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec3</span> <span class="token function">calcNormal</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">float</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token number">.01</span> <span class="token operator">*</span> t <span class="token operator">*</span> <span class="token number">.33</span><span class="token punctuation">;</span>
	<span class="token keyword">vec2</span> e <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.5773</span> <span class="token operator">*</span> d<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>xyy <span class="token operator">*</span> <span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">+</span> e<span class="token punctuation">.</span>xyy<span class="token punctuation">)</span><span class="token punctuation">.</span>d <span class="token operator">+</span> e<span class="token punctuation">.</span>yyx <span class="token operator">*</span> <span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">+</span> e<span class="token punctuation">.</span>yyx<span class="token punctuation">)</span><span class="token punctuation">.</span>d <span class="token operator">+</span> e<span class="token punctuation">.</span>yxy <span class="token operator">*</span> <span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">+</span> e<span class="token punctuation">.</span>yxy<span class="token punctuation">)</span><span class="token punctuation">.</span>d <span class="token operator">+</span> e<span class="token punctuation">.</span>xxx <span class="token operator">*</span> <span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">+</span> e<span class="token punctuation">.</span>xxx<span class="token punctuation">)</span><span class="token punctuation">.</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Quick ambient occlusion.</span>
<span class="token keyword">float</span> <span class="token function">ao</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> n<span class="token punctuation">,</span> <span class="token keyword">float</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">+</span> h <span class="token operator">*</span> n<span class="token punctuation">)</span><span class="token punctuation">.</span>d <span class="token operator">/</span> h<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">/**********************************************************************************/</span>
<span class="token keyword">vec3</span> <span class="token function">vignette</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> col<span class="token punctuation">,</span> <span class="token keyword">vec2</span> fragCoord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">vec2</span> q <span class="token operator">=</span> fragCoord<span class="token punctuation">.</span>xy <span class="token operator">/</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
	col <span class="token operator">*=</span> <span class="token number">.5</span> <span class="token operator">+</span> <span class="token number">.5</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">16.</span> <span class="token operator">*</span> q<span class="token punctuation">.</span>x <span class="token operator">*</span> q<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.</span> <span class="token operator">-</span> q<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.</span> <span class="token operator">-</span> q<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> col<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec3</span> <span class="token function">applyLighting</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> rd<span class="token punctuation">,</span> <span class="token keyword">float</span> d<span class="token punctuation">,</span> MarchData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">vec3</span> sunDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span>
	     n <span class="token operator">=</span> <span class="token function">calcNormal</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Primary light.</span>
	<span class="token keyword">float</span> primary <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>sunDir<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	      bounce <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span><span class="token operator">-</span>sunDir<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.2</span><span class="token punctuation">,</span>
	      spe <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>rd<span class="token punctuation">,</span> <span class="token function">reflect</span><span class="token punctuation">(</span>sunDir<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>specPower<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span><span class="token punctuation">,</span>
	      fre <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">1.</span> <span class="token operator">+</span> <span class="token function">dot</span><span class="token punctuation">(</span>rd<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	      fog <span class="token operator">=</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Combine.</span>
	primary <span class="token operator">*=</span> <span class="token function">mix</span><span class="token punctuation">(</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token function">calcShadow</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">mix</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>mat <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>primary <span class="token operator">+</span> bounce<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">ao</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token number">.33</span><span class="token punctuation">)</span> <span class="token operator">+</span> spe<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1.6</span><span class="token punctuation">,</span> <span class="token number">1.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fre<span class="token punctuation">)</span> <span class="token operator">*</span> fog<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec3</span> <span class="token function">getSceneColor</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> ro<span class="token punctuation">,</span> <span class="token keyword">vec3</span> rd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Raymarch.</span>
	<span class="token keyword">vec3</span> p<span class="token punctuation">;</span>
	<span class="token keyword">float</span> g<span class="token punctuation">,</span>
	      d <span class="token operator">=</span> <span class="token number">.01</span><span class="token punctuation">;</span>
	MarchData h<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">float</span> steps <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">;</span> steps <span class="token operator">&lt;</span> <span class="token number">120.</span><span class="token punctuation">;</span> steps<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		p <span class="token operator">=</span> ro <span class="token operator">+</span> rd <span class="token operator">*</span> d<span class="token punctuation">;</span>
		h <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>d<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">.0015</span> <span class="token operator">*</span> d<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">&gt;</span> <span class="token number">64.</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Distance limit reached - Stop.</span>
		d <span class="token operator">+=</span> h<span class="token punctuation">.</span>d<span class="token punctuation">;</span> <span class="token comment">// No hit, so keep marching.</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Lighting.</span>
	g <span class="token operator">=</span> glow<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">applyLighting</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> rd<span class="token punctuation">,</span> d<span class="token punctuation">,</span> h<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fireShock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.3</span> <span class="token operator">+</span> g<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">mainImage</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token keyword">vec4</span> fragColor<span class="token punctuation">,</span> <span class="token keyword">vec2</span> fragCoord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	edWalk <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">;</span>
	edTwist <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">;</span>
	edDown <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">;</span>
	edShoot <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">;</span>
	doorOpen <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">;</span>
	stretch <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">;</span>

	<span class="token comment">// Camera.</span>
	<span class="token keyword">vec3</span> ro<span class="token punctuation">,</span> lookAt<span class="token punctuation">,</span> col<span class="token punctuation">;</span>
	<span class="token keyword">float</span> startScene<span class="token punctuation">,</span> endScene<span class="token punctuation">,</span> dim<span class="token punctuation">,</span>
	      time <span class="token operator">=</span> <span class="token function">mod</span><span class="token punctuation">(</span>u_time<span class="token punctuation">,</span> <span class="token number">55.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;</span> <span class="token number">12.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		startScene <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">;</span>
		endScene <span class="token operator">=</span> <span class="token number">12.</span><span class="token punctuation">;</span>
		edWalk <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">;</span>
		ro <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">.625</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		lookAt <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		doorOpen <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> time <span class="token operator">/</span> <span class="token number">5.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stretch <span class="token operator">=</span> <span class="token function">remap</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token number">7.</span><span class="token punctuation">,</span> <span class="token number">10.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;</span> <span class="token number">25.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		startScene <span class="token operator">=</span> <span class="token number">12.</span><span class="token punctuation">;</span>
		endScene <span class="token operator">=</span> <span class="token number">25.</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> t <span class="token operator">=</span> time <span class="token operator">-</span> startScene<span class="token punctuation">;</span>
		edWalk <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token function">remap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">3.</span><span class="token punctuation">,</span> <span class="token number">8.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		ro <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">.5</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>t <span class="token operator">*</span> <span class="token number">.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.5</span> <span class="token operator">-</span> t <span class="token operator">*</span> <span class="token number">.1</span><span class="token punctuation">,</span> <span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		lookAt <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;</span> <span class="token number">29.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		startScene <span class="token operator">=</span> <span class="token number">25.</span><span class="token punctuation">;</span>
		endScene <span class="token operator">=</span> <span class="token number">29.</span><span class="token punctuation">;</span>
		ro <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">.5</span> <span class="token operator">+</span> <span class="token punctuation">(</span>time <span class="token operator">-</span> startScene<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.1</span><span class="token punctuation">,</span> <span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		lookAt <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;</span> <span class="token number">37.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		startScene <span class="token operator">=</span> <span class="token number">29.</span><span class="token punctuation">;</span>
		endScene <span class="token operator">=</span> <span class="token number">37.</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> t <span class="token operator">=</span> time <span class="token operator">-</span> startScene<span class="token punctuation">;</span>
		ro <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.</span> <span class="token operator">-</span> t <span class="token operator">*</span> <span class="token number">.05</span><span class="token punctuation">,</span> <span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">5.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		lookAt <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stretch <span class="token operator">=</span> <span class="token function">remap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">2.</span><span class="token punctuation">,</span> <span class="token number">5.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;</span> <span class="token number">55.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		startScene <span class="token operator">=</span> <span class="token number">37.</span><span class="token punctuation">;</span>
		endScene <span class="token operator">=</span> <span class="token number">55.</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> t <span class="token operator">=</span> time <span class="token operator">-</span> startScene<span class="token punctuation">;</span>
		ro <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stretch <span class="token operator">=</span> <span class="token function">remap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">2.</span><span class="token punctuation">,</span> <span class="token number">3.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">remap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">11.5</span><span class="token punctuation">,</span> <span class="token number">14.5</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		lookAt <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> stretch <span class="token operator">*</span> <span class="token number">.5</span> <span class="token operator">-</span> <span class="token number">.5</span><span class="token punctuation">,</span> <span class="token function">edZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		edTwist <span class="token operator">=</span> <span class="token function">remap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">3.</span><span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">*</span> stretch<span class="token punctuation">;</span>
		edDown <span class="token operator">=</span> <span class="token function">remap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">*</span> stretch<span class="token punctuation">;</span>
		edShoot <span class="token operator">=</span> t <span class="token operator">&lt;=</span> <span class="token number">9.5</span> <span class="token operator">?</span> <span class="token function">remap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">4.</span><span class="token punctuation">,</span> <span class="token number">9.5</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	dim <span class="token operator">=</span> <span class="token number">1.</span> <span class="token operator">-</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">2.</span> <span class="token operator">*</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>time <span class="token operator">-</span> startScene<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span>time <span class="token operator">-</span> endScene<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.5705</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	col <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">AA</span></span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">float</span> dx <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">;</span> dx <span class="token operator">&lt;=</span> <span class="token number">1.</span><span class="token punctuation">;</span> dx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">float</span> dy <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">;</span> dy <span class="token operator">&lt;=</span> <span class="token number">1.</span><span class="token punctuation">;</span> dy<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">vec2</span> coord <span class="token operator">=</span> fragCoord <span class="token operator">+</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
			<span class="token keyword">vec2</span> coord <span class="token operator">=</span> fragCoord<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
			coord <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">fireShock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">23242.232</span><span class="token punctuation">,</span> <span class="token number">978.23465</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10.</span><span class="token punctuation">;</span>
			<span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token punctuation">(</span>coord <span class="token operator">-</span> <span class="token number">.5</span> <span class="token operator">*</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">/</span> u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
			col <span class="token operator">+=</span> <span class="token function">getSceneColor</span><span class="token punctuation">(</span>ro<span class="token punctuation">,</span> <span class="token function">getRayDir</span><span class="token punctuation">(</span>ro<span class="token punctuation">,</span> lookAt<span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">AA</span></span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	col <span class="token operator">/=</span> <span class="token number">4.</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token comment">// Output to screen.</span>
	fragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token function">vignette</span><span class="token punctuation">(</span><span class="token function">pow</span><span class="token punctuation">(</span>col <span class="token operator">*</span> dim<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.4545</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fragCoord<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">mainImage</span><span class="token punctuation">(</span>gl_FragColor<span class="token punctuation">,</span>vUv <span class="token operator">*</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1)),s("h3",d,[n[4]||(n[4]=s("a",{class:"header-anchor",href:"#fractalcity","aria-hidden":"true"},"#",-1)),n[5]||(n[5]=a()),o(t,{to:"/markdown/example/fractalCity.html"},{default:e(()=>n[3]||(n[3]=[a("fractalCity")])),_:1})]),n[20]||(n[20]=p(`<div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_time<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_resolution<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_frame<span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_position<span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> vUv<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">R</span> <span class="token expression">u_resolution</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">repeat</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">mod</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token operator">-</span>r<span class="token operator">/</span><span class="token number">2.</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">mat2</span> <span class="token function">rot</span><span class="token punctuation">(</span><span class="token keyword">float</span> a<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">mat2</span><span class="token punctuation">(</span><span class="token function">cos</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token function">sin</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sin</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">cos</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">vec3</span> <span class="token function">look</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> from<span class="token punctuation">,</span><span class="token keyword">vec3</span> at<span class="token punctuation">,</span><span class="token keyword">vec2</span> uv<span class="token punctuation">,</span><span class="token keyword">float</span> fov<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">vec3</span> z<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>at<span class="token operator">-</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">vec3</span> x<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">vec3</span> y<span class="token operator">=</span><span class="token function">cross</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span>z<span class="token operator">*</span>fov<span class="token operator">+</span>uv<span class="token punctuation">.</span>x<span class="token operator">*</span>x<span class="token operator">+</span>uv<span class="token punctuation">.</span>y<span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token keyword">uint</span> k<span class="token operator">=</span><span class="token number">1103515245U</span><span class="token punctuation">;</span>

<span class="token keyword">vec3</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token keyword">uvec3</span> x<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  x<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">&gt;&gt;</span><span class="token number">8U</span><span class="token punctuation">)</span><span class="token operator">^</span>x<span class="token punctuation">.</span>yzx<span class="token punctuation">)</span><span class="token operator">*</span>k<span class="token punctuation">;</span>
  x<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">&gt;&gt;</span><span class="token number">8U</span><span class="token punctuation">)</span><span class="token operator">^</span>x<span class="token punctuation">.</span>yzx<span class="token punctuation">)</span><span class="token operator">*</span>k<span class="token punctuation">;</span>
  x<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">&gt;&gt;</span><span class="token number">8U</span><span class="token punctuation">)</span><span class="token operator">^</span>x<span class="token punctuation">.</span>yzx<span class="token punctuation">)</span><span class="token operator">*</span>k<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">/</span><span class="token keyword">float</span><span class="token punctuation">(</span><span class="token number">0xffffffffU</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token keyword">float</span> speed<span class="token operator">=</span><span class="token number">.05</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> falloff<span class="token operator">=</span><span class="token number">1.75</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> range<span class="token operator">=</span><span class="token number">.5</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> count<span class="token operator">=</span><span class="token number">8.</span><span class="token punctuation">;</span>

<span class="token comment">// globals</span>
<span class="token keyword">vec3</span> pp<span class="token punctuation">,</span>ppp<span class="token punctuation">;</span>
<span class="token keyword">float</span> mat<span class="token punctuation">,</span>glow<span class="token punctuation">;</span>


<span class="token keyword">float</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token number">100.</span><span class="token punctuation">;</span>
   <span class="token keyword">float</span> shape <span class="token operator">=</span> <span class="token number">100.</span><span class="token punctuation">;</span>
   <span class="token keyword">vec3</span> pos <span class="token operator">=</span> p<span class="token punctuation">;</span>
   pp <span class="token operator">=</span> p<span class="token punctuation">;</span>
   ppp <span class="token operator">=</span> p<span class="token punctuation">;</span><span class="token comment">// travel</span>
   <span class="token keyword">float</span> px<span class="token operator">=</span>p<span class="token punctuation">.</span>x<span class="token operator">-</span>u_time<span class="token operator">*</span>speed<span class="token punctuation">;</span>
   <span class="token keyword">float</span> ix<span class="token operator">=</span><span class="token function">floor</span><span class="token punctuation">(</span>px<span class="token punctuation">)</span><span class="token punctuation">;</span>
   p<span class="token punctuation">.</span>x<span class="token operator">=</span><span class="token function">repeat</span><span class="token punctuation">(</span>px<span class="token punctuation">,</span><span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token comment">// city</span>
   <span class="token keyword">float</span> a<span class="token operator">=</span><span class="token number">1.</span><span class="token punctuation">;</span>
   <span class="token keyword">float</span> angle<span class="token operator">=</span><span class="token number">196.</span><span class="token operator">+</span>ix<span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">float</span> i<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>count<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>xz<span class="token operator">*=</span><span class="token function">rot</span><span class="token punctuation">(</span>angle<span class="token operator">/</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token operator">=</span><span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-</span>range<span class="token operator">*</span>a<span class="token punctuation">;</span>
        shape<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mat<span class="token operator">=</span>shape<span class="token operator">&lt;</span>dist<span class="token operator">?</span>i<span class="token operator">:</span>mat<span class="token punctuation">;</span>
        pp<span class="token operator">=</span>i<span class="token operator">==</span><span class="token number">7.</span><span class="token operator">?</span>p<span class="token operator">:</span>pp<span class="token punctuation">;</span>
        ppp<span class="token operator">=</span>i<span class="token operator">==</span><span class="token number">6.</span><span class="token operator">?</span>p<span class="token operator">:</span>ppp<span class="token punctuation">;</span>
        dist<span class="token operator">=</span><span class="token function">min</span><span class="token punctuation">(</span>dist<span class="token punctuation">,</span>shape<span class="token punctuation">)</span><span class="token punctuation">;</span>
        a<span class="token operator">/=</span>falloff<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    dist<span class="token operator">=</span><span class="token operator">-</span>dist<span class="token punctuation">;</span>
    
    <span class="token comment">// columns</span>
    shape<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">.001</span><span class="token punctuation">,</span>dist<span class="token operator">-</span><span class="token number">.005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dist<span class="token operator">=</span><span class="token function">min</span><span class="token punctuation">(</span>dist<span class="token punctuation">,</span>shape<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// lights</span>
    shape<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>ppp<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">.001</span><span class="token punctuation">,</span>dist<span class="token operator">-</span><span class="token number">.001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    glow<span class="token operator">+=</span><span class="token number">.0001</span><span class="token operator">/</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">.0005</span><span class="token punctuation">,</span>shape<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// crop</span>
    dist<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>dist<span class="token punctuation">,</span><span class="token function">abs</span><span class="token punctuation">(</span>pos<span class="token punctuation">.</span>y<span class="token operator">-</span><span class="token number">.1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> dist<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// from Inigo Quilez</span>
<span class="token keyword">float</span> <span class="token function">shadow</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> pos<span class="token punctuation">,</span><span class="token keyword">vec3</span> at<span class="token punctuation">,</span><span class="token keyword">float</span> k<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">vec3</span> dir<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>at<span class="token operator">-</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> maxt<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span>at<span class="token operator">-</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> f<span class="token operator">=</span><span class="token number">1.</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> t<span class="token operator">=</span><span class="token number">.002</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">float</span> i<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">1.</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">1.</span><span class="token operator">/</span><span class="token number">30.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">float</span> dist<span class="token operator">=</span><span class="token function">map</span><span class="token punctuation">(</span>pos<span class="token operator">+</span>dir<span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dist<span class="token operator">&lt;</span><span class="token number">.001</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0.</span><span class="token punctuation">;</span>
      f<span class="token operator">=</span><span class="token function">min</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span>k<span class="token operator">*</span>dist<span class="token operator">/</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
      t<span class="token operator">+=</span>dist<span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token operator">&gt;=</span>maxt<span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    <span class="token keyword">return</span> f<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">rect</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token keyword">vec4</span> fragColor<span class="token punctuation">,</span><span class="token keyword">in</span> <span class="token keyword">vec2</span> fragCoord<span class="token punctuation">)</span><span class="token punctuation">{</span>
fragColor<span class="token operator">=</span><span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span><span class="token number">0.</span><span class="token punctuation">,</span><span class="token number">0.</span><span class="token punctuation">,</span><span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">const</span> <span class="token keyword">float</span> frames<span class="token operator">=</span><span class="token number">3.</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">float</span> frame<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">;</span>frame<span class="token operator">&lt;</span>frames<span class="token punctuation">;</span><span class="token operator">++</span>frame<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">// coordinates</span>
    <span class="token keyword">vec2</span> uv<span class="token operator">=</span>fragCoord<span class="token operator">/</span>R<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> p<span class="token operator">=</span><span class="token number">2.</span><span class="token operator">*</span><span class="token punctuation">(</span>fragCoord<span class="token operator">-</span>R<span class="token punctuation">.</span>xy<span class="token operator">/</span><span class="token number">2.</span><span class="token punctuation">)</span><span class="token operator">/</span>R<span class="token punctuation">.</span>y<span class="token punctuation">;</span>    
        <span class="token comment">// anti aliasing</span>
        <span class="token keyword">float</span> aa<span class="token operator">=</span><span class="token number">6.28</span><span class="token operator">*</span>frame<span class="token operator">/</span>frames<span class="token punctuation">;</span>
        p<span class="token operator">+=</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">cos</span><span class="token punctuation">(</span>aa<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sin</span><span class="token punctuation">(</span>aa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>R<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
        
        <span class="token keyword">vec3</span> pos<span class="token operator">=</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">.04</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">.02</span><span class="token punctuation">,</span><span class="token number">.09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">vec3</span> ray<span class="token operator">=</span><span class="token function">look</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span><span class="token number">4.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">vec3</span> rng<span class="token operator">=</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token keyword">uvec3</span><span class="token punctuation">(</span>fragCoord<span class="token punctuation">,</span><span class="token keyword">float</span><span class="token punctuation">(</span>u_frame<span class="token punctuation">)</span><span class="token operator">+</span>frame<span class="token operator">*</span><span class="token number">196.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// init globals</span>
        glow<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">;</span>
        mat<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">;</span>
        <span class="token comment">// raymarch</span>
        <span class="token keyword">float</span> total<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> steps<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">float</span> count<span class="token operator">=</span><span class="token number">100.</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">float</span> max_dist<span class="token operator">=</span><span class="token number">4.</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>steps<span class="token operator">=</span>count<span class="token punctuation">;</span>steps<span class="token operator">&gt;</span><span class="token number">0.</span><span class="token punctuation">;</span><span class="token operator">--</span>steps<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">float</span> dist<span class="token operator">=</span><span class="token function">map</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>dist<span class="token operator">&lt;</span><span class="token number">.001</span><span class="token operator">*</span>total<span class="token operator">||</span>total<span class="token operator">&gt;</span>max_dist<span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
            dist<span class="token operator">*=</span><span class="token number">.9</span><span class="token operator">+</span><span class="token number">.1</span><span class="token operator">*</span>rng<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
            total<span class="token operator">+=</span>dist<span class="token punctuation">;</span>
            pos<span class="token operator">+=</span>ray<span class="token operator">*</span>dist<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">vec4</span> result<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>total<span class="token operator">&lt;</span>max_dist<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// lighting</span>
            <span class="token keyword">float</span> shade<span class="token operator">=</span>steps<span class="token operator">/</span>count<span class="token punctuation">;</span>
            <span class="token keyword">vec3</span> sun<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec3</span> palette<span class="token operator">=</span><span class="token number">.5</span><span class="token operator">+</span><span class="token number">.5</span><span class="token operator">*</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">5.</span><span class="token operator">+</span>pos<span class="token punctuation">.</span>z<span class="token operator">*</span><span class="token number">6.</span><span class="token operator">+</span>pos<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token number">6.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec3</span> color<span class="token operator">=</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            color<span class="token operator">*=</span><span class="token function">sin</span><span class="token punctuation">(</span>mat<span class="token operator">+</span><span class="token number">1.</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">.25</span><span class="token operator">+</span><span class="token number">.75</span><span class="token punctuation">;</span>
            color<span class="token operator">*=</span><span class="token function">step</span><span class="token punctuation">(</span><span class="token number">.01</span><span class="token punctuation">,</span>ppp<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">.25</span><span class="token operator">+</span><span class="token number">.75</span><span class="token punctuation">;</span>
            color<span class="token operator">*=</span><span class="token function">step</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>y<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">.005</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">.25</span><span class="token operator">+</span><span class="token number">.75</span><span class="token punctuation">;</span>
            color<span class="token operator">+=</span>palette<span class="token operator">*</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">.1</span><span class="token operator">/</span><span class="token function">abs</span><span class="token punctuation">(</span>mat<span class="token operator">-</span><span class="token number">10.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.</span><span class="token punctuation">,</span><span class="token number">1.</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">.9</span><span class="token punctuation">;</span>
            color<span class="token operator">+=</span>palette<span class="token operator">*</span>glow<span class="token punctuation">;</span>
            color<span class="token operator">*=</span>shade<span class="token punctuation">;</span>
            color<span class="token operator">*=</span><span class="token number">.4</span><span class="token operator">+</span><span class="token number">.6</span><span class="token operator">*</span><span class="token function">shadow</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span>sun<span class="token punctuation">,</span><span class="token number">100.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token operator">=</span><span class="token keyword">vec4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// sky</span>
            <span class="token keyword">vec3</span> color<span class="token operator">=</span><span class="token number">.5</span><span class="token operator">+</span><span class="token number">.5</span><span class="token operator">*</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">5.</span><span class="token operator">+</span>uv<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token number">2.</span><span class="token operator">+</span><span class="token number">2.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token operator">=</span><span class="token keyword">vec4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// sum it up</span>
        fragColor<span class="token operator">+=</span>result<span class="token operator">/</span>frames<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">rect</span><span class="token punctuation">(</span>gl_FragColor<span class="token punctuation">,</span>vUv <span class="token operator">*</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1)),s("h3",m,[n[7]||(n[7]=s("a",{class:"header-anchor",href:"#lightsaberduel","aria-hidden":"true"},"#",-1)),n[8]||(n[8]=a()),o(t,{to:"/markdown/example/lightSaberDuel.html"},{default:e(()=>n[6]||(n[6]=[a("lightSaberDuel")])),_:1})]),n[21]||(n[21]=p(`<div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code>
<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_resolution<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_mouse<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_time<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> iChannel0<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> iChannel1<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">int</span> u_frame<span class="token punctuation">;</span>

<span class="token comment">// #define FOCAL_LENGTH 1.2</span>
<span class="token comment">// #define MOVE_SPEED 20.</span>
<span class="token comment">// #define MAX_STEPS 256</span>
<span class="token comment">// #define MIN_DIST.01</span>
<span class="token comment">// #define MAX_DIST 75.</span>
<span class="token comment">// #define AMBIANT_LIGHT.01</span>
<span class="token comment">// #define DAY_LENGTH 15.</span>

<span class="token comment">// #define PI 3.14159265359</span>

<span class="token comment">// #define TWO_EGGS</span>

<span class="token comment">// #define QUALITY_MEDIUM</span>

<span class="token comment">// #if defined(QUALITY_HIGH)</span>

<span class="token comment">// #define VOL_SHADOW_STEPS 5.</span>
<span class="token comment">// #define MIN_STEP_BIAS.3</span>
<span class="token comment">// #define VOL_FOG 1</span>
<span class="token comment">// #define VOL_SHADOW 1</span>
<span class="token comment">// #define LIGHT_QUALITY 1</span>

<span class="token comment">// #elif defined(QUALITY_MEDIUM)</span>

<span class="token comment">// #define VOL_SHADOW_STEPS 2.</span>
<span class="token comment">// #define MIN_STEP_BIAS.6</span>
<span class="token comment">// #define VOL_FOG 1</span>
<span class="token comment">// #define VOL_SHADOW 1</span>
<span class="token comment">// #define LIGHT_QUALITY 1</span>

<span class="token comment">// #elif defined(QUALITY_LOW)</span>

<span class="token comment">// #define VOL_SHADOW_STEPS 1.</span>
<span class="token comment">// #define MIN_STEP_BIAS.9</span>
<span class="token comment">// #define VOL_FOG 1</span>
<span class="token comment">// #define VOL_SHADOW 0</span>
<span class="token comment">// #define LIGHT_QUALITY 0</span>

<span class="token comment">// #elif defined(QUALITY_OFF)</span>

<span class="token comment">// #define VOL_SHADOW_STEPS 1.</span>
<span class="token comment">// #define MIN_STEP_BIAS 1.</span>
<span class="token comment">// #define VOL_FOG 0</span>
<span class="token comment">// #define VOL_SHADOW 0</span>
<span class="token comment">// #define LIGHT_QUALITY 0</span>

<span class="token comment">// #endif</span>

<span class="token comment">// #define LASER_STR 1.5</span>
<span class="token comment">// #define LASER_CORE vec3(.5)</span>
<span class="token comment">// #define LASER_LIGHT_STR 1.5</span>
<span class="token comment">// #define PURPLE vec3(.5,0.,1.5)</span>
<span class="token comment">// #define GREEN vec3(0.,1.,0.)</span>
<span class="token comment">// #define BLUE vec3(0.,0.,1.)*2.</span>
<span class="token comment">// #define RED vec3(1.,0.,0.)*1.5</span>
<span class="token comment">// #define YELLOW vec3(.6,.6,0.)</span>

<span class="token comment">// #define JEDI GREEN</span>
<span class="token comment">// #define SITH RED</span>

<span class="token comment">// #define JEDI_SABER_NOISE 2.</span>
<span class="token comment">// #define SITH_SABER_NOISE 5.</span>

<span class="token comment">// vec3 zero=vec3(0.,0.,0.);</span>

<span class="token comment">// vec3 projectionUp;</span>
<span class="token comment">// vec3 projectionRight;</span>
<span class="token comment">// vec3 projectionForward;</span>
<span class="token comment">// vec3 projectionCenter;</span>
<span class="token comment">// vec3 cameraOffset;</span>
<span class="token comment">// float dayProgress;</span>
<span class="token comment">// float minSurfaceDist;</span>

<span class="token comment">// vec4 plane=vec4(vec3(0.,1.,0.),1.);</span>
<span class="token comment">// vec3 sunLightPos;</span>

<span class="token comment">// vec4 groundColor=vec4(vec3(.08),.7);</span>
<span class="token comment">// vec4 handleColor=vec4(vec3(.1),.3);</span>
<span class="token comment">// vec3 sunLightColor;</span>
<span class="token comment">// vec3 skyColor;</span>
<span class="token comment">// vec3 fogColor;</span>

<span class="token comment">// float s_pixelRand=0.;</span>
<span class="token comment">// float s_time=0.;</span>

<span class="token comment">// float mapToRange(float fromMin,float fromMax,float toMin,float toMax,float val)</span>
<span class="token comment">// {</span>
<span class="token comment">//     val=max(fromMin,(min(fromMax,val)));</span>
<span class="token comment">//     float fromSize=fromMax-fromMin;</span>
<span class="token comment">//     val=(val-fromMin)/fromSize;</span>
<span class="token comment">//     return mix(toMin,toMax,val);</span>
<span class="token comment">// }</span>

<span class="token comment">// vec3 noise3(in vec3 x)</span>
<span class="token comment">// {</span>
<span class="token comment">//     return texture2D(iChannel0,x.xy/x.z,0.).xyz;</span>
<span class="token comment">// }</span>

<span class="token comment">// #if VOL_FOG</span>

<span class="token comment">// float layeredNoise(vec3 p)</span>
<span class="token comment">// {</span>
<span class="token comment">//     float f;</span>
<span class="token comment">//     f=.5000*texture2D(iChannel1,p).x;</span>
<span class="token comment">//     p=p*2.;</span>
<span class="token comment">//     f+=.2500*texture2D(iChannel1,p).x;</span>
<span class="token comment">//     p=p*2.;</span>
<span class="token comment">//     f+=.1250*texture2D(iChannel1,p).x;</span>
<span class="token comment">//     p=p*2.;</span>
<span class="token comment">//     f+=.0800*texture2D(iChannel1,p).x;</span>
<span class="token comment">//     p=p*2.;</span>
<span class="token comment">//     f+=.0625*texture2D(iChannel1,p).x;</span>
<span class="token comment">//     p=p*2.;</span>
    
<span class="token comment">//     return f;</span>
<span class="token comment">// }</span>

<span class="token comment">// #define CONSTANT_FOG.03</span>
<span class="token comment">// // To simplify: wavelength independent scattering and extinction</span>
<span class="token comment">// float atmThickness(in vec3 pos)</span>
<span class="token comment">// {</span>
<span class="token comment">//     float disp1=.5;</span>
<span class="token comment">//     float disp2=.5;</span>
    
<span class="token comment">//     //disp1 = mapToRange(0.5, 1.0, 0.1, 1.0, layeredNoise(pos.xz*0.015 + s_time*0.008));</span>
<span class="token comment">//     disp1=mapToRange(.3,1.,.1,1.,layeredNoise(pos*.02-vec3(0.,1.,0.)*s_time*.01));</span>
<span class="token comment">//     //float noise = clamp(mapToRange(0.4, 0.8, 0.0, 1.0, disp2),0.0,1.0);</span>
<span class="token comment">//     float fogMax=-1.-smoothstep(8.,-3.,length(pos.xz));</span>
<span class="token comment">//     float fogMin=fogMax+disp1*3.;</span>
<span class="token comment">//     float heightFog=smoothstep(fogMin,fogMax,pos.y);</span>
    
<span class="token comment">//     heightFog=min(1.,heightFog*3.);</span>
    
<span class="token comment">//     return CONSTANT_FOG+heightFog*2.;</span>
<span class="token comment">// }</span>

<span class="token comment">// float phaseFunctionVal=1./(4.*PI);</span>
<span class="token comment">// #define PHASE_FUNC phaseFunctionVal</span>

<span class="token comment">// float volumetricShadow(in vec3 from,in vec3 dir)</span>
<span class="token comment">// {</span>
<span class="token comment">//     float shadow=1.;</span>
<span class="token comment">//     float cloud=0.;</span>
<span class="token comment">//     float dd=1./VOL_SHADOW_STEPS;</span>
<span class="token comment">//     vec3 pos;</span>
<span class="token comment">//     for(float s=.5;s&lt;VOL_SHADOW_STEPS-.1;s+=1.)// start at 0.5 to sample at center of integral part</span>
<span class="token comment">//     {</span>
<span class="token comment">//         pos=from+dir*(s/VOL_SHADOW_STEPS);</span>
<span class="token comment">//         cloud=atmThickness(pos);</span>
<span class="token comment">//         shadow*=exp(-cloud*dd);</span>
<span class="token comment">//     }</span>
<span class="token comment">//     return shadow;</span>
<span class="token comment">// }</span>

<span class="token comment">// #endif</span>

<span class="token comment">// vec2 pixelToNormalizedspace(vec2 pixel)</span>
<span class="token comment">// {</span>
<span class="token comment">//     vec2 res;</span>
<span class="token comment">//     res.x=pixel.x*2./u_resolution.x-1.;</span>
<span class="token comment">//     res.y=pixel.y*2./u_resolution.y-1.;</span>
<span class="token comment">//     res.y*=u_resolution.y/u_resolution.x;//correct aspect ratio</span>
<span class="token comment">//     return res;</span>
<span class="token comment">// }</span>

<span class="token comment">// float fCapsule(vec3 p,float r,float c){</span>
<span class="token comment">//     return mix(length(p.xz)-r,length(vec3(p.x,abs(p.y)-c,p.z))-r,step(c,abs(p.y)));</span>
<span class="token comment">// }</span>

<span class="token comment">// float fSphere(vec3 d,float r)</span>
<span class="token comment">// {</span>
<span class="token comment">//     return length(d)-r;</span>
<span class="token comment">// }</span>

<span class="token comment">// float fPlane(vec4 plane,vec3 point)</span>
<span class="token comment">// {</span>
<span class="token comment">//     return abs(dot(plane,vec4(point,1.)));</span>
<span class="token comment">// }</span>

<span class="token comment">// // Hexagonal prism, circumcircle variant</span>
<span class="token comment">// float fHexagonCircumcircle(vec3 p,vec2 h){</span>
<span class="token comment">//     vec3 q=abs(p);</span>
<span class="token comment">//     //return max(q.y - h.y, max(q.x*sqrt(3)*0.5 + q.z*0.5, q.z) - h.x);</span>
<span class="token comment">//     //this is mathematically equivalent to this line, but less efficient:</span>
<span class="token comment">//     return max(q.y-h.y,max(dot(vec2(cos(PI/3.),sin(PI/3.)),q.zx),q.z)-h.x);</span>
<span class="token comment">// }</span>

<span class="token comment">// // Repeat in two dimensions</span>
<span class="token comment">// vec2 pMod2(inout vec2 p,vec2 size){</span>
<span class="token comment">//     vec2 c=floor((p+size*.5)/size);</span>
<span class="token comment">//     p=mod(p+size*.5,size)-size*.5;</span>
<span class="token comment">//     return c;</span>
<span class="token comment">// }</span>

<span class="token comment">// //////////////////////////////</span>

<span class="token comment">// float linearstep(float e1,float e2,float v)</span>
<span class="token comment">// {</span>
<span class="token comment">//     v=clamp(v,e1,e2);</span>
<span class="token comment">//     return(v-e1)/(e2-e1);</span>
<span class="token comment">// }</span>

<span class="token comment">// float fEgg(vec3 d,float r,vec3 deform)</span>
<span class="token comment">// {</span>
<span class="token comment">//     return length(d/deform)-r;</span>
<span class="token comment">// }</span>

<span class="token comment">// #define IMAT3 mat3(vec3(1.,0.,0.),vec3(0.,1.,0.),vec3(0.,0.,1.))</span>

<span class="token comment">// float maxDist=100.;</span>

<span class="token comment">// //constants</span>
<span class="token comment">// float handRSize=.15;</span>
<span class="token comment">// float handLSize=.15;</span>
<span class="token comment">// float footRSize=.22;</span>
<span class="token comment">// float footLSize=.22;</span>
<span class="token comment">// vec3 eyeRPos=vec3(.2,.2,0.);</span>
<span class="token comment">// vec3 eyeLPos=vec3(-.2,.2,0.);</span>
<span class="token comment">// float eyeRSize=.105;</span>
<span class="token comment">// float eyeLSize=.105;</span>
<span class="token comment">// vec3 mouthPos=vec3(0.,0.,-.03);</span>
<span class="token comment">// float mouthSize=.1;</span>
<span class="token comment">// float mouthXRot=PI*.325;</span>
<span class="token comment">// float handleRadius=.1;</span>
<span class="token comment">// float handleLen=.35;</span>
<span class="token comment">// vec4 bodyColor=vec4(vec3(.1),.8);</span>
<span class="token comment">// vec4 eyeColor=vec4(vec3(.9),.1);</span>
<span class="token comment">// vec4 eyeInsideColor=vec4(vec3(.1),.1);</span>
<span class="token comment">// vec4 mouthColor=vec4(1.,1.,0.,.1);</span>

<span class="token comment">// struct StickmanData</span>
<span class="token comment">// {</span>
<span class="token comment">//     vec3 stickmanPos;</span>
<span class="token comment">//     //relative to stickManPos</span>
<span class="token comment">//     vec3 bodyPos;</span>
<span class="token comment">//     vec3 bodyDeform;</span>
<span class="token comment">//     vec3 headPos;</span>
<span class="token comment">//     vec3 handRPos;</span>
<span class="token comment">//     vec3 handLPos;</span>
<span class="token comment">//     vec3 handRDeform;</span>
<span class="token comment">//     vec3 handLDeform;</span>
<span class="token comment">//     mat3 handRRot;</span>
<span class="token comment">//     mat3 handLRot;</span>
    
<span class="token comment">//     vec3 footRPos;</span>
<span class="token comment">//     vec3 footLPos;</span>
<span class="token comment">//     mat3 footRRot;</span>
<span class="token comment">//     mat3 footLRot;</span>
<span class="token comment">//     vec3 footRDeform;</span>
<span class="token comment">//     vec3 footLDeform;</span>
    
<span class="token comment">//     mat3 invBodyRot;</span>
<span class="token comment">//     mat3 invStickmanRot;</span>
<span class="token comment">//     mat3 invMouthRot;</span>
    
<span class="token comment">//     //relative to headPos</span>
    
<span class="token comment">//     vec3 eyeRDeform;</span>
<span class="token comment">//     vec3 eyeLDeform;</span>
    
<span class="token comment">//     vec3 mouthDeform;</span>
    
<span class="token comment">//     vec3 saberTarget;</span>
<span class="token comment">//     vec3 saberPos;</span>
<span class="token comment">//     float saberRadius;</span>
<span class="token comment">//     float saberLen;</span>
<span class="token comment">//     float saberNoise;</span>
<span class="token comment">//     mat3 invSaberRot;</span>
    
<span class="token comment">//     vec3 laserColor;</span>
<span class="token comment">//     vec3 laserLight;</span>
<span class="token comment">// };</span>

<span class="token comment">// StickmanData jediData;</span>
<span class="token comment">// StickmanData sithData;</span>

<span class="token comment">// struct FieldData</span>
<span class="token comment">// {</span>
<span class="token comment">//     vec3 saberDiff;</span>
<span class="token comment">//     vec3 saberOffset;</span>
<span class="token comment">//     vec3 handleOffset;</span>
<span class="token comment">//     float fSaber;</span>
<span class="token comment">// };</span>

<span class="token comment">// FieldData jediFieldData;</span>
<span class="token comment">// FieldData sithFieldData;</span>

<span class="token comment">// void rotationZ(float r,out mat3 mat)</span>
<span class="token comment">// {</span>
<span class="token comment">//     mat[0].x=cos(r);mat[0].y=sin(r);mat[0].z=0.;</span>
<span class="token comment">//     mat[1].x=-sin(r);mat[1].y=cos(r);mat[1].z=0.;</span>
<span class="token comment">//     mat[2].x=0.;mat[2].y=0.;mat[2].z=1.;</span>
<span class="token comment">// }</span>

<span class="token comment">// void rotationY(float r,out mat3 mat)</span>
<span class="token comment">// {</span>
<span class="token comment">//     mat[0].x=cos(r);mat[0].y=0.;mat[0].z=-sin(r);</span>
<span class="token comment">//     mat[1].x=0.;mat[1].y=1.;mat[1].z=0.;</span>
<span class="token comment">//     mat[2].x=sin(r);mat[2].y=0.;mat[2].z=cos(r);</span>
<span class="token comment">// }</span>

<span class="token comment">// void rotationX(float r,out mat3 mat)</span>
<span class="token comment">// {</span>
<span class="token comment">//     mat[0].x=1.;mat[0].y=0.;mat[0].z=0.;</span>
<span class="token comment">//     mat[1].x=0.;mat[1].y=cos(r);mat[1].z=sin(r);</span>
<span class="token comment">//     mat[2].x=0.;mat[2].y=-sin(r);mat[2].z=cos(r);</span>
<span class="token comment">// }</span>

<span class="token comment">// //wonderfull function from iq&#39;s article</span>
<span class="token comment">// //https://iquilezles.org/articles/noacos</span>
<span class="token comment">// void rotationAlign(vec3 d,vec3 z,out mat3 mat)</span>
<span class="token comment">// {</span>
<span class="token comment">//     vec3 v=cross(z,d);</span>
<span class="token comment">//     float c=dot(z,d);</span>
<span class="token comment">//     float k=1./(1.+c);</span>
    
<span class="token comment">//     mat=mat3(v.x*v.x*k+c,v.y*v.x*k-v.z,v.z*v.x*k+v.y,</span>
<span class="token comment">//         v.x*v.y*k+v.z,v.y*v.y*k+c,v.z*v.y*k-v.x,</span>
<span class="token comment">//     v.x*v.z*k-v.y,v.y*v.z*k+v.x,v.z*v.z*k+c);</span>
<span class="token comment">// }</span>

<span class="token comment">// //ugly hack to get partial look at rotation, works well enough</span>
<span class="token comment">// void rotationAlign(vec3 targ,vec3 dir,float i,out mat3 mat)</span>
<span class="token comment">// {</span>
<span class="token comment">//     vec3 diff=targ-dir;</span>
<span class="token comment">//     if(dot(diff,diff)&gt;.1)</span>
<span class="token comment">//     {</span>
<span class="token comment">//         vec3 mixed=normalize(mix(targ,dir,1.-i));</span>
<span class="token comment">//         rotationAlign(mixed,dir,mat);</span>
<span class="token comment">//     }</span>
<span class="token comment">//     else</span>
<span class="token comment">//     {</span>
<span class="token comment">//         mat=IMAT3;</span>
<span class="token comment">//     }</span>
<span class="token comment">// }</span>

<span class="token comment">// //pre-computes field data that doesn&#39;t change during the raymarching</span>
<span class="token comment">// void computeFieldData(in StickmanData data,out FieldData fieldData)</span>
<span class="token comment">// {</span>
<span class="token comment">//     fieldData.saberDiff=data.bodyPos+data.saberPos*data.bodyDeform;</span>
<span class="token comment">//     fieldData.saberOffset=vec3(0.,-data.saberLen-handleLen,0.);</span>
<span class="token comment">//     fieldData.handleOffset=vec3(0.,handleLen*.5,0.);</span>
<span class="token comment">//     fieldData.fSaber=MAX_DIST;</span>
<span class="token comment">// }</span>

<span class="token comment">// float fSaber(vec3 d,in StickmanData data,in FieldData fieldData)</span>
<span class="token comment">// {</span>
<span class="token comment">//     vec3 saberDiff=d-fieldData.saberDiff;</span>
<span class="token comment">//     saberDiff=data.invSaberRot*saberDiff;</span>
<span class="token comment">//     float saber=fCapsule(saberDiff+fieldData.saberOffset,</span>
<span class="token comment">//         data.saberRadius</span>
<span class="token comment">//         *(pow(mapToRange(data.saberLen*1.95,data.saberLen*2.+handleLen,1.,.01,saberDiff.y),.35))</span>
<span class="token comment">//         *mapToRange(0.,1.,.85,1.,sin(s_time*30.-saberDiff.y*data.saberNoise)),</span>
<span class="token comment">//     data.saberLen);</span>
    
<span class="token comment">//     return saber;</span>
<span class="token comment">// }</span>

<span class="token comment">// float fHandle(vec3 d,in StickmanData data,in FieldData fieldData)</span>
<span class="token comment">// {</span>
<span class="token comment">//     vec3 saberDiff=d-fieldData.saberDiff;</span>
<span class="token comment">//     saberDiff=data.invSaberRot*saberDiff;</span>
<span class="token comment">//     float handle=fCapsule(saberDiff+fieldData.handleOffset,</span>
<span class="token comment">//         handleRadius,</span>
<span class="token comment">//     handleLen);</span>
<span class="token comment">//     return handle;</span>
<span class="token comment">// }</span>

<span class="token comment">// vec4 fStickman(vec3 d,in StickmanData data,in FieldData fieldData,inout float minDist)</span>
<span class="token comment">// {</span>
<span class="token comment">//     float r=s_time*3.14*.5;</span>
    
<span class="token comment">//     vec3 bodyD=data.invBodyRot*(d-data.bodyPos);</span>
<span class="token comment">//     vec3 fixedBodyD=d-data.bodyPos;</span>
<span class="token comment">//     //main body</span>
<span class="token comment">//     float body=fEgg(bodyD,1.,data.bodyDeform);</span>
<span class="token comment">//     float subBody=fEgg(bodyD+vec3(0.,.6,.5),1.,data.bodyDeform*vec3(.8,.8,.8));</span>
<span class="token comment">//     //eyes</span>
<span class="token comment">//     float eye=fEgg(bodyD-(data.headPos+eyeLPos)*data.bodyDeform,eyeLSize,data.eyeLDeform);</span>
<span class="token comment">//     eye=min(eye,fEgg(bodyD-(data.headPos+eyeRPos)*data.bodyDeform,eyeRSize,data.eyeRDeform));</span>
    
<span class="token comment">//     float subEye=fEgg(bodyD-(data.headPos+eyeLPos+vec3(.07,-.03,-.1))*data.bodyDeform,</span>
<span class="token comment">//     eyeLSize,data.eyeLDeform*vec3(.3,.4,.3));</span>
<span class="token comment">//     subEye=min(subEye,fEgg(bodyD-(data.headPos+eyeRPos+vec3(-.07,-.03,-.1))*data.bodyDeform,</span>
<span class="token comment">//     eyeLSize,data.eyeLDeform*vec3(.3,.4,.3)));</span>
<span class="token comment">//     eye=min(eye,subEye);</span>
    
<span class="token comment">//     //mouth</span>
<span class="token comment">//     float mouth=fEgg(</span>
<span class="token comment">//         data.invMouthRot*(bodyD-(data.headPos+mouthPos)*data.bodyDeform),</span>
<span class="token comment">//     mouthSize,data.mouthDeform);</span>
    
<span class="token comment">//     //hands</span>
<span class="token comment">//     float hands;</span>
<span class="token comment">//     hands=fEgg(data.handRRot*(fixedBodyD-data.handRPos*data.bodyDeform),</span>
<span class="token comment">// handRSize,data.handRDeform);</span>
<span class="token comment">// hands=min(hands,fEgg(data.handLRot*(fixedBodyD-data.handLPos*data.bodyDeform),</span>
<span class="token comment">// handLSize,data.handLDeform));</span>
<span class="token comment">// //feet</span>
<span class="token comment">// float feet;</span>
<span class="token comment">// feet=fEgg(data.footRRot*(d-(data.footRPos)),</span>
<span class="token comment">// footRSize,data.footRDeform);</span>
<span class="token comment">// feet=min(feet,fEgg(data.footLRot*(d-(data.footLPos)),</span>
<span class="token comment">// footLSize,data.footLDeform));</span>
<span class="token comment">// //saber</span>
<span class="token comment">// float saber=fieldData.fSaber;//fSaber(d, data, fieldData);</span>
<span class="token comment">// float handle=fHandle(d,data,fieldData);</span>

<span class="token comment">// minDist=min(minDist,body);</span>
<span class="token comment">// minDist=min(minDist,eye);</span>
<span class="token comment">// minDist=min(minDist,mouth);</span>
<span class="token comment">// minDist=min(minDist,hands);</span>
<span class="token comment">// minDist=min(minDist,feet);</span>
<span class="token comment">// minDist=min(minDist,saber);</span>
<span class="token comment">// minDist=min(minDist,handle);</span>

<span class="token comment">// vec4 color=vec4(0.);//egg bolor</span>
<span class="token comment">// color+=mix(bodyColor,vec4(vec3(.9),.8),step(subBody,body))*step(body,minDist);</span>
<span class="token comment">// color+=mix(eyeColor,bodyColor,step(subEye,eye))*step(eye,minDist);</span>
<span class="token comment">// color+=bodyColor*step(hands,minDist);</span>
<span class="token comment">// color+=bodyColor*step(feet,minDist);</span>
<span class="token comment">// color+=mouthColor*step(mouth,minDist);</span>
<span class="token comment">// color+=vec4(data.laserColor,0.)*step(saber,minDist);</span>
<span class="token comment">// color+=handleColor*step(handle,minDist);</span>

<span class="token comment">// return color;</span>
<span class="token comment">// }</span>

<span class="token comment">// //transition functions</span>
<span class="token comment">// float pingPong(float p)</span>
<span class="token comment">// {</span>
<span class="token comment">// return 1.-abs(p*2.-1.);</span>
<span class="token comment">// }</span>

<span class="token comment">// float minHandDist=1.2;</span>
<span class="token comment">// float maxHandDist=1.7;</span>

<span class="token comment">// void invKinOneHand(float i,mat3 alignRot,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// data.handLPos=data.handLPos*alignRot;</span>
<span class="token comment">// }</span>

<span class="token comment">// void invKinTwoHand(float i,mat3 alignRot,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// vec3 f=vec3(0.,0.,1.);</span>
<span class="token comment">// vec3 dir=normalize(mix(f,data.invSaberRot*f,i));</span>

<span class="token comment">// mat3 rot;</span>
<span class="token comment">// rotationAlign(f,dir,rot);</span>
<span class="token comment">// data.handLRot=data.handLRot*rot;</span>

<span class="token comment">// vec3 target=data.handRPos+vec3(0.,-.3,0.)*data.invSaberRot;</span>
<span class="token comment">// float l=mix(length(data.handLPos),max(length(target),minHandDist),i);</span>
<span class="token comment">// data.handLPos=normalize(mix(data.handLPos,target,pow(i,.5)))*l;</span>
<span class="token comment">// }</span>

<span class="token comment">// vec3 neutralTarget=vec3(0.,0.,-1.);</span>
<span class="token comment">// float ll=1.;//leg length ratio</span>

<span class="token comment">// void invKinematics(float twoHanded,float hit,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// data.saberTarget=normalize(data.saberTarget);</span>
<span class="token comment">// mat3 alignRot;</span>

<span class="token comment">// //rotate saber</span>
<span class="token comment">// rotationAlign(data.saberTarget,vec3(0.,1.,0.)*data.invSaberRot,hit,alignRot);</span>
<span class="token comment">// data.invSaberRot=data.invSaberRot*alignRot;</span>

<span class="token comment">// //move hand/handle</span>
<span class="token comment">// data.saberPos=mix(data.saberPos,maxHandDist*normalize(data.saberPos),hit);</span>
<span class="token comment">// rotationAlign(data.saberTarget,neutralTarget,.8,alignRot);</span>
<span class="token comment">// vec3 armTarget=neutralTarget*alignRot;</span>
<span class="token comment">// rotationAlign(armTarget,normalize(data.saberPos),hit,alignRot);</span>
<span class="token comment">// data.saberPos*=alignRot;</span>

<span class="token comment">// data.saberPos=max(length(data.saberPos),minHandDist)*normalize(data.saberPos);</span>
<span class="token comment">// data.handRPos=data.saberPos;</span>
<span class="token comment">// data.handRRot=data.invSaberRot;</span>
<span class="token comment">// //move body stance</span>
<span class="token comment">// data.bodyPos=mix(data.footRPos,data.footLPos,.5)+vec3(0.,data.bodyPos.y,.1);</span>
<span class="token comment">// //turn body</span>
<span class="token comment">// vec3 bodyRestDir=normalize(vec3(1.,-.5,-.5));</span>
<span class="token comment">// vec3 saberDir=normalize(mix(bodyRestDir,data.saberPos,.3));</span>
<span class="token comment">// rotationAlign(saberDir,bodyRestDir,alignRot);</span>
<span class="token comment">// data.invBodyRot*=alignRot;</span>
<span class="token comment">// //back hand rot</span>
<span class="token comment">// saberDir=normalize(mix(bodyRestDir,data.saberPos,1.-twoHanded));</span>
<span class="token comment">// rotationAlign(saberDir,bodyRestDir,alignRot);</span>

<span class="token comment">// //squint eyes while you hit, just because ....</span>
<span class="token comment">// data.eyeLDeform.y*=1.-hit*.4;</span>
<span class="token comment">// data.eyeRDeform.y*=1.-hit*.5;</span>

<span class="token comment">// invKinOneHand(1.-twoHanded,alignRot,data);</span>
<span class="token comment">// invKinTwoHand(twoHanded,alignRot,data);</span>
<span class="token comment">// }</span>

<span class="token comment">// float frontLoop(float i,float t,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// float dur=1.;</span>
<span class="token comment">// float r=mod(t,dur)/dur;</span>
<span class="token comment">// float p=pingPong(r)*i;</span>

<span class="token comment">// mat3 rotY;</span>
<span class="token comment">// rotationY(PI*i*-.15,rotY);</span>

<span class="token comment">// mat3 rotX;</span>
<span class="token comment">// rotationX(PI*2.*r*i,rotX);</span>

<span class="token comment">// data.invSaberRot=rotX*data.invSaberRot*rotY;</span>

<span class="token comment">// vec3 offset=vec3(0.,.7,.7)*.4*data.invSaberRot;</span>
<span class="token comment">// data.saberPos.x+=.7*i;</span>
<span class="token comment">// data.saberPos.y+=.6*i;</span>
<span class="token comment">// data.saberPos.z+=.3*i;</span>
<span class="token comment">// data.saberPos-=offset;</span>

<span class="token comment">// return 0.;</span>
<span class="token comment">// }</span>

<span class="token comment">// float backLoop(float i,float t,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// float dur=1.;</span>
<span class="token comment">// float r=mod(t,dur)/dur;</span>
<span class="token comment">// float p=pingPong(r)*i;</span>

<span class="token comment">// mat3 rotY;</span>
<span class="token comment">// rotationY(PI*i*-.1,rotY);</span>

<span class="token comment">// mat3 rotX;</span>
<span class="token comment">// rotationX(PI*2.*r*i,rotX);</span>

<span class="token comment">// data.invSaberRot=rotX*data.invSaberRot*rotY;</span>

<span class="token comment">// vec3 offset=vec3(0.,.65,.7)*.3*data.invSaberRot;</span>

<span class="token comment">// data.saberPos.y+=.55*i;</span>
<span class="token comment">// data.saberPos-=offset;</span>

<span class="token comment">// return 0.;</span>
<span class="token comment">// }</span>

<span class="token comment">// float nullMove(float i,float m,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// return 0.;</span>
<span class="token comment">// }</span>

<span class="token comment">// float nullPose(float i,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// return 0.;</span>
<span class="token comment">// }</span>

<span class="token comment">// float whirlingHit(float i,float m,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// float p1d=.3;</span>
<span class="token comment">// float p2d=.4;</span>
<span class="token comment">// float p3d=.3;</span>

<span class="token comment">// float t=i;</span>
<span class="token comment">// //arming part</span>
<span class="token comment">// float p1=smoothstep(0.,p1d,t);</span>
<span class="token comment">// //hitting part</span>
<span class="token comment">// float p2=linearstep(p1d,p1d+p2d,t);</span>
<span class="token comment">// p2=min(m,p2);</span>
<span class="token comment">// //back to rest part</span>
<span class="token comment">// float p3=linearstep(p1d+p2d,p1d+p2d+p3d,t);</span>

<span class="token comment">// //move the target on trajectory</span>
<span class="token comment">// vec3 start=vec3(.8,-.3,.3);</span>
<span class="token comment">// vec3 end=vec3(-.5,-.1,-.45);</span>
<span class="token comment">// vec3 target=mix(start,end,p2);</span>
<span class="token comment">// target.y+=.3*pingPong(p2);</span>
<span class="token comment">// //target = mix(target, neutralTarget, pow(p3, 0.4));</span>
<span class="token comment">// data.saberTarget=mix(data.saberTarget,target,p1);</span>

<span class="token comment">// //stance</span>
<span class="token comment">// data.footRPos=mix(data.footRPos,ll*vec3(.4,.1,data.footLPos.z+1.2),(p1-p3));</span>
<span class="token comment">// data.footRPos=mix(data.footRPos,ll*vec3(.4,.1,data.footLPos.z-1.2),pow(p2-p3,2.));</span>
<span class="token comment">// data.footRPos.y+=pingPong(p1-p3)*ll*.1;</span>
<span class="token comment">// //footRPos.y += pingPong(p2 - p3)*ll*0.1;</span>

<span class="token comment">// float landing=pingPong(linearstep(p1d+p2d*.7,p1d+p2d+p3d*.5,t));</span>
<span class="token comment">// float takeoff=1.-pow(1.-(smoothstep(0.,p1d*.6,t)-smoothstep(p1d*.6,p1d+p2d*.1,t)),2.);</span>
<span class="token comment">// float jump=1.-pow(1.-(smoothstep(p1d,p1d+p2d*.5,t)-smoothstep(p1d+p2d*.5,p1d+p2d,t)),3.);</span>

<span class="token comment">// data.bodyPos.y+=-takeoff*.3+jump*.4-landing*.2;</span>
<span class="token comment">// data.bodyDeform.y+=-takeoff*.1+jump*.05-landing*.1;</span>
<span class="token comment">// data.stickmanPos.y+=jump*1.;</span>
<span class="token comment">// //footRPos.y -= jump*0.4;</span>
<span class="token comment">// data.footLPos.y-=jump*.4;</span>

<span class="token comment">// float r=smoothstep(p1d,p1d+p2d,t);</span>
<span class="token comment">// mat3 rotY;</span>
<span class="token comment">// rotationY(PI*-2.*r,rotY);</span>

<span class="token comment">// mat3 rotX;</span>
<span class="token comment">// rotationX(PI*.1*pow((p1+jump)*.5,2.),rotX);</span>

<span class="token comment">// data.invStickmanRot=rotY*rotX*data.invStickmanRot;</span>

<span class="token comment">// return p1-p3;</span>
<span class="token comment">// }</span>

<span class="token comment">// float forwardHit(float i,float m,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// float p=step(i,.5)*pow(i*2.,2.)+step(.5,i)*smoothstep(1.,.5,i);//pingPong(i);</span>
<span class="token comment">// data.saberTarget=step(i,.001)*data.saberTarget+step(.001,i)*vec3(.3,0.,-2.);</span>

<span class="token comment">// float mp=min(m,p);</span>
<span class="token comment">// //stance</span>
<span class="token comment">// data.footRPos=mix(data.footRPos,ll*vec3(.4,.1,data.footLPos.z-1.5),mp);</span>
<span class="token comment">// data.footRPos.y+=pingPong(p)*ll*.1;</span>
<span class="token comment">// return mp;</span>
<span class="token comment">// }</span>

<span class="token comment">// float upDownHit(float i,float m,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// float p1d=.2;</span>
<span class="token comment">// float p2d=.6;</span>
<span class="token comment">// float p3d=.2;</span>

<span class="token comment">// float t=i;</span>
<span class="token comment">// //arming part</span>
<span class="token comment">// float p1=smoothstep(0.,p1d,t);</span>
<span class="token comment">// float p2=1.-pow(1.-linearstep(p1d,p1d+p2d,t),1.);</span>
<span class="token comment">// p2=min(m,p2);</span>
<span class="token comment">// float p3=linearstep(p2d,p1d+p2d+p3d,t);</span>

<span class="token comment">// //move the target on trajectory</span>
<span class="token comment">// vec3 start=vec3(.8,.35,.3);</span>
<span class="token comment">// vec3 end=vec3(-1.,-.45,-.45);</span>
<span class="token comment">// vec3 target=mix(start,end,p2);//mix(mix(start, end, p2), neutralTarget, pow(p3, 0.4));</span>
<span class="token comment">// data.saberTarget=mix(data.saberTarget,target,p1);</span>

<span class="token comment">// //stance</span>
<span class="token comment">// data.footRPos=mix(data.footRPos,ll*vec3(.4,.1,data.footLPos.z-1.2),(p1-p3));</span>
<span class="token comment">// data.footRPos.y+=pingPong(p1-p3)*ll*.1;</span>
<span class="token comment">// return p1-p3;</span>
<span class="token comment">// }</span>

<span class="token comment">// float parryUpRight(float i,float m,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// float p=1.-pow(1.-pingPong(i),4.);</span>

<span class="token comment">// mat3 alignRot;</span>
<span class="token comment">// vec3 restTarget=vec3(0.,1.,0.)*data.invSaberRot;</span>
<span class="token comment">// vec3 armTarget=vec3(-1.,.15,-.1);</span>
<span class="token comment">// rotationAlign(armTarget,restTarget,p,alignRot);</span>
<span class="token comment">// data.invSaberRot=data.invSaberRot*alignRot;</span>

<span class="token comment">// data.saberPos=mix(data.saberPos,vec3(.6,.42,-1.7),p);</span>

<span class="token comment">// //squint eyes while you parry, just because ....</span>
<span class="token comment">// data.eyeLDeform.y*=1.-p*.4;</span>
<span class="token comment">// data.eyeRDeform.y*=1.-p*.6;</span>

<span class="token comment">// //stance</span>
<span class="token comment">// data.footRPos=mix(data.footRPos,ll*vec3(.8,.1,data.footRPos.z+.5),p);</span>
<span class="token comment">// data.footRPos.y+=pingPong(p)*ll*.1;</span>
<span class="token comment">// return 0.;</span>
<span class="token comment">// }</span>

<span class="token comment">// float parryDownLeft(float i,float m,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// float p=1.-pow(1.-pingPong(i),4.);</span>

<span class="token comment">// mat3 alignRot;</span>
<span class="token comment">// vec3 restTarget=vec3(0.,1.,0.)*data.invSaberRot;</span>
<span class="token comment">// vec3 saberTarget=vec3(-.2,1.,-.5);</span>
<span class="token comment">// rotationAlign(saberTarget,restTarget,p,alignRot);</span>
<span class="token comment">// data.invSaberRot=data.invSaberRot*alignRot;</span>

<span class="token comment">// data.saberPos=mix(data.saberPos,vec3(-.9,-.5,-1.4),p);</span>

<span class="token comment">// //squint eyes while you parry, just because ....</span>
<span class="token comment">// data.eyeLDeform.y*=1.-p*.4;</span>
<span class="token comment">// data.eyeRDeform.y*=1.-p*.6;</span>

<span class="token comment">// //stance</span>
<span class="token comment">// data.footRPos=mix(data.footRPos,ll*vec3(.7,.1,data.footRPos.z+.5),p);</span>
<span class="token comment">// data.footRPos.y+=pingPong(p)*ll*.1;</span>
<span class="token comment">// return 0.;</span>
<span class="token comment">// }</span>

<span class="token comment">// void iddle(float t,float i,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// //mouth</span>
<span class="token comment">// float dur=3.;</span>
<span class="token comment">// float p;</span>
<span class="token comment">// //p = pingPong(mod(t, dur)/dur)*i;</span>
<span class="token comment">// //mouthDeform *= 0.9 + 0.2*p;</span>
<span class="token comment">// //body</span>
<span class="token comment">// p=pingPong(mod(t-.1,dur)/dur)*i;</span>
<span class="token comment">// data.bodyDeform*=.975+.025*p;</span>
<span class="token comment">// //hands</span>
<span class="token comment">// float r=p*PI*-.07;</span>
<span class="token comment">// data.handRRot=data.handRRot*mat3(vec3(cos(r),sin(r),0.),</span>
<span class="token comment">// vec3(-sin(r),cos(r),0.),</span>
<span class="token comment">// vec3(0.,0.,1.));</span>
<span class="token comment">// r=-r;</span>
<span class="token comment">// data.handLRot=data.handLRot*mat3(vec3(cos(r),sin(r),0.),</span>
<span class="token comment">// vec3(-sin(r),cos(r),0.),</span>
<span class="token comment">// vec3(0.,0.,1.));</span>
<span class="token comment">// //eyes</span>
<span class="token comment">// dur=5.;</span>
<span class="token comment">// p=pingPong(smoothstep(dur-.3,dur,mod(t,dur)))*i;</span>
<span class="token comment">// data.eyeRDeform.y*=1.-p;</span>
<span class="token comment">// data.eyeLDeform.y*=1.-p;</span>
<span class="token comment">// }</span>

<span class="token comment">// float poseSaberSide(float i,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// data.saberPos=mix(data.saberPos,vec3(1.,-.2,-.8),i);</span>
<span class="token comment">// mat3 xRot;</span>
<span class="token comment">// rotationX(PI*.07*i,xRot);</span>
<span class="token comment">// data.invSaberRot=data.invSaberRot*xRot;</span>

<span class="token comment">// //foot placement</span>
<span class="token comment">// data.footLPos=mix(data.footLPos,vec3(-.8,.1,-.6*ll),i);</span>
<span class="token comment">// data.footLPos.y+=ll*.1*pingPong(i);</span>

<span class="token comment">// return 1.;</span>
<span class="token comment">// }</span>

<span class="token comment">// float poseSaberFront(float i,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// data.saberPos=mix(data.saberPos,vec3(.2,-.4,-1.4),i);</span>
<span class="token comment">// mat3 xRot;</span>
<span class="token comment">// rotationX(PI*.25*i,xRot);</span>
<span class="token comment">// data.invSaberRot=data.invSaberRot*xRot;</span>

<span class="token comment">// //foot placement</span>
<span class="token comment">// data.footRPos=mix(data.footRPos,vec3(.6,.1,-.8*ll),i);</span>
<span class="token comment">// data.footRPos.y+=ll*.1*pingPong(i);</span>
<span class="token comment">// return 0.;</span>
<span class="token comment">// }</span>

<span class="token comment">// float poseSaberBack(float i,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// mat3 xRot;</span>
<span class="token comment">// rotationX(.55*PI*i,xRot);</span>
<span class="token comment">// mat3 yRot;</span>
<span class="token comment">// rotationY(-.07*PI*i,yRot);</span>

<span class="token comment">// data.invSaberRot=data.invSaberRot*xRot*yRot;</span>

<span class="token comment">// mat3 zRot;</span>
<span class="token comment">// rotationZ(PI*.4*i,zRot);</span>
<span class="token comment">// data.handLRot=data.handLRot*zRot;</span>
<span class="token comment">// data.handLPos=mix(data.handLPos,vec3(-1.3,.3,-.9),i);</span>
<span class="token comment">// data.saberPos=mix(data.saberPos,vec3(1.3,.2,.5),i);</span>

<span class="token comment">// //foot placement</span>
<span class="token comment">// data.footLPos=mix(data.footLPos,vec3(-.6,.1,-1.*ll),i);</span>
<span class="token comment">// data.footLPos.y+=ll*.1*pingPong(i);</span>
<span class="token comment">// return 0.;</span>
<span class="token comment">// }</span>

<span class="token comment">// float poseSaberBackDown(float i,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// mat3 xRot;</span>
<span class="token comment">// rotationX(.65*PI*i,xRot);</span>
<span class="token comment">// mat3 yRot;</span>
<span class="token comment">// rotationY(.3*PI*i,yRot);</span>

<span class="token comment">// data.invSaberRot=data.invSaberRot*xRot*yRot;</span>

<span class="token comment">// mat3 zRot;</span>
<span class="token comment">// rotationZ(PI*.4*i,zRot);</span>
<span class="token comment">// data.handLRot=data.handLRot*zRot;</span>
<span class="token comment">// data.handLPos=mix(data.handLPos,vec3(-1.2,-.3,-.8),i);</span>

<span class="token comment">// data.saberPos=mix(data.saberPos,vec3(1.3,-.3,.5),i);</span>

<span class="token comment">// //foot placement</span>
<span class="token comment">// data.footLPos=mix(data.footLPos,vec3(-.7,.1,-.7*ll),i);</span>
<span class="token comment">// data.footLPos.y+=ll*.1*pingPong(i);</span>
<span class="token comment">// return 0.;</span>
<span class="token comment">// }</span>

<span class="token comment">// float animateEntranceJedi(float p,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// data.saberLen*=smoothstep(.05,.3,p);</span>
<span class="token comment">// float pose1=1.-smoothstep(.52,.7,p);</span>
<span class="token comment">// poseSaberFront(pose1,data);</span>

<span class="token comment">// frontLoop(smoothstep(.3,.4,p)-smoothstep(.65,.7,p),linearstep(.3,.65,p)*2.,data);</span>

<span class="token comment">// float pose2=smoothstep(.5,.7,p);</span>
<span class="token comment">// poseSaberSide(pose2,data);</span>

<span class="token comment">// return pose2;</span>
<span class="token comment">// }</span>

<span class="token comment">// float animateEntranceSith(float p,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// data.saberLen*=smoothstep(.05,.15,p);</span>
<span class="token comment">// float pose1=1.-smoothstep(.52,.6,p);</span>
<span class="token comment">// poseSaberBackDown(pose1,data);</span>

<span class="token comment">// backLoop(max(smoothstep(.2,.25,p)-smoothstep(.55,.6,p),.00001),linearstep(.2,.55,p)*3.,data);</span>

<span class="token comment">// float pose2=smoothstep(.5,.6,p);</span>
<span class="token comment">// poseSaberBack(pose2,data);</span>
<span class="token comment">// return 0.;</span>
<span class="token comment">// }</span>

<span class="token comment">// #define ANIMATE 1</span>

<span class="token comment">// //assumes t is time</span>
<span class="token comment">// //i is a float</span>
<span class="token comment">// //data is the stickman</span>
<span class="token comment">// //hit receives the hit progress</span>
<span class="token comment">// //twoHanded receives the two hand amount</span>
<span class="token comment">// #define HIT_SEQ(s,e,m,hitAnim)if(t&gt;s&amp;&amp;t&lt;=e){i=(t-s)/(e-s);hit=hitAnim(i,m,data);}</span>
<span class="token comment">// #define HOLD_POSE(s,e,poseAnim)if(t&gt;s&amp;&amp;t&lt;=e){twoHanded=poseAnim(1.,data);}</span>
<span class="token comment">// #define TRANS_POSE(s,e,prevPoseAnim,poseAnim)if(t&gt;s&amp;&amp;t&lt;=e){i=(t-s)/(e-s);prevTwoHanded=prevPoseAnim(1.-i,data);twoHanded=poseAnim(i,data);twoHanded=mix(prevTwoHanded,twoHanded,i);}</span>

<span class="token comment">// float loopTime=9.5;</span>

<span class="token comment">// void animateJedi(float t,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// float entranceDur=4.5;</span>
<span class="token comment">// float prevTwoHanded=0.;</span>
<span class="token comment">// float twoHanded=0.;</span>
<span class="token comment">// float i=0.;</span>
<span class="token comment">// float hit=0.;</span>
<span class="token comment">// float s,e;</span>

<span class="token comment">// #if ANIMATE</span>
<span class="token comment">// s=-entranceDur;</span>
<span class="token comment">// e=0.;</span>
<span class="token comment">// TRANS_POSE(s,e,nullPose,animateEntranceJedi)</span>

<span class="token comment">// t=mod(t,loopTime)*step(0.,t);</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.5;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberSide)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.7;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberSide)</span>
<span class="token comment">// HIT_SEQ(s,e,1.,parryDownLeft)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.2;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberSide)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+1.65;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberSide)</span>
<span class="token comment">// HIT_SEQ(s,e,.60,whirlingHit)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+1.;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberSide)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.9;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberSide)</span>
<span class="token comment">// HIT_SEQ(s,e,1.,parryDownLeft)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.45;</span>
<span class="token comment">// TRANS_POSE(s,e,poseSaberSide,poseSaberFront)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.9;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberFront)</span>
<span class="token comment">// HIT_SEQ(s,e,1.,parryDownLeft)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+2.;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberFront)</span>
<span class="token comment">// HIT_SEQ(s,e,.4375,upDownHit)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.4;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberFront)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.6;</span>
<span class="token comment">// TRANS_POSE(s,e,poseSaberFront,poseSaberSide)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=loopTime;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberSide)</span>
<span class="token comment">// #endif</span>

<span class="token comment">// invKinematics(twoHanded,hit,data);</span>
<span class="token comment">// }</span>

<span class="token comment">// void animateSith(float t,inout StickmanData data)</span>
<span class="token comment">// {</span>
<span class="token comment">// float entranceDur=4.5;</span>
<span class="token comment">// float twoHanded=0.;</span>
<span class="token comment">// float i=0.;</span>
<span class="token comment">// float hit=0.;</span>
<span class="token comment">// float prevTwoHanded=0.;</span>

<span class="token comment">// float s,e;</span>
<span class="token comment">// #if ANIMATE</span>
<span class="token comment">// //do pose</span>
<span class="token comment">// s=-entranceDur;</span>
<span class="token comment">// e=0.;</span>
<span class="token comment">// TRANS_POSE(s,e,nullPose,animateEntranceSith)</span>

<span class="token comment">// t=mod(t,loopTime)*step(0.,t);</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+1.7;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberBack)</span>
<span class="token comment">// HIT_SEQ(s,e,.434,upDownHit)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.6;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberBack)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.6;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberBack)</span>
<span class="token comment">// HIT_SEQ(s,e,1.,parryUpRight)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.5;</span>
<span class="token comment">// TRANS_POSE(s,e,poseSaberBack,poseSaberBackDown)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+1.5;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberBackDown)</span>
<span class="token comment">// HIT_SEQ(s,e,.558,whirlingHit)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.4;</span>
<span class="token comment">// TRANS_POSE(s,e,poseSaberBackDown,poseSaberBack)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+1.;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberBack)</span>
<span class="token comment">// HIT_SEQ(s,e,.6,forwardHit)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.1;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberBack)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.42;</span>
<span class="token comment">// TRANS_POSE(s,e,poseSaberBack,poseSaberBackDown)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+1.2;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberBackDown)</span>
<span class="token comment">// HIT_SEQ(s,e,1.,parryDownLeft)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.8;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberBackDown)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=s+.5;</span>
<span class="token comment">// TRANS_POSE(s,e,poseSaberBackDown,poseSaberBack)</span>

<span class="token comment">// s=e;</span>
<span class="token comment">// e=loopTime;</span>
<span class="token comment">// HOLD_POSE(s,e,poseSaberBack)</span>
<span class="token comment">// #endif</span>

<span class="token comment">// invKinematics(twoHanded,hit,data);</span>
<span class="token comment">// }</span>

<span class="token comment">// void initStickman(inout StickmanData data,bool isJedi)</span>
<span class="token comment">// {</span>
<span class="token comment">// data.stickmanPos=vec3(0.,-1.,0.);</span>
<span class="token comment">// //relative to stickManPos</span>
<span class="token comment">// data.bodyPos=vec3(0.,1.5,0.);</span>
<span class="token comment">// data.bodyDeform=vec3(1.,1.15,1.);</span>
<span class="token comment">// data.headPos=vec3(0.,.05,-.92);</span>
<span class="token comment">// data.handRPos=vec3(1.1,-.45,-.5);</span>
<span class="token comment">// data.handLPos=vec3(-1.1,-.45,-.5);</span>
<span class="token comment">// data.handRDeform=vec3(1.2,1.5,1.6);</span>
<span class="token comment">// data.handLDeform=vec3(1.2,1.5,1.6);</span>
<span class="token comment">// data.handRRot=IMAT3;</span>
<span class="token comment">// data.handLRot=IMAT3;</span>
<span class="token comment">// data.footRPos=vec3(.6,.1,-.1);</span>
<span class="token comment">// data.footLPos=vec3(-.6,.1,-.1);</span>
<span class="token comment">// data.footRRot=IMAT3;</span>
<span class="token comment">// data.footLRot=IMAT3;</span>
<span class="token comment">// data.footRDeform=vec3(1.5,.9,1.8);</span>
<span class="token comment">// data.footLDeform=vec3(1.5,.9,1.8);</span>

<span class="token comment">// data.invBodyRot=IMAT3;</span>
<span class="token comment">// data.invStickmanRot=IMAT3;</span>
<span class="token comment">// data.invMouthRot=IMAT3;</span>

<span class="token comment">// //relative to headPos</span>
<span class="token comment">// data.eyeRDeform=vec3(2.,1.8,1.);</span>
<span class="token comment">// data.eyeLDeform=vec3(2.,2.5,1.);</span>

<span class="token comment">// data.mouthDeform=vec3(2.,1.,3.5);</span>

<span class="token comment">// data.saberPos=vec3(1.1,-.45,-.5);</span>
<span class="token comment">// data.saberRadius=.06;</span>
<span class="token comment">// data.saberLen=.85;</span>
<span class="token comment">// data.saberNoise=isJedi?JEDI_SABER_NOISE:SITH_SABER_NOISE;</span>
<span class="token comment">// data.invSaberRot=IMAT3;</span>

<span class="token comment">// data.laserColor=LASER_CORE+(isJedi?JEDI:SITH);</span>
<span class="token comment">// data.laserLight=(data.laserColor-LASER_CORE)*LASER_LIGHT_STR;</span>

<span class="token comment">// rotationX(mouthXRot,data.invMouthRot);</span>
<span class="token comment">// }</span>

<span class="token comment">// vec4 characterField(vec3 p,inout float minDist)</span>
<span class="token comment">// {</span>
<span class="token comment">// vec4 jediField=vec4(maxDist);</span>
<span class="token comment">// vec4 sithField=vec4(maxDist);</span>
<span class="token comment">// float jediMinDist=MAX_DIST;</span>
<span class="token comment">// float sithMinDist=MAX_DIST;</span>
<span class="token comment">// jediField=fStickman(jediData.invStickmanRot*(p-jediData.stickmanPos),jediData,jediFieldData,jediMinDist);</span>
<span class="token comment">// #ifdef TWO_EGGS</span>
<span class="token comment">// sithField=fStickman(sithData.invStickmanRot*(p-sithData.stickmanPos),sithData,sithFieldData,sithMinDist);</span>
<span class="token comment">// #endif</span>
<span class="token comment">// minDist=min(jediMinDist,sithMinDist);</span>
<span class="token comment">// return jediField*step(jediMinDist,minDist)+sithField*step(sithMinDist,minDist);</span>
<span class="token comment">// }</span>

<span class="token comment">// ////////////////////////////////</span>

<span class="token comment">// //get distance to nearest surface and atmosphere/surface color</span>
<span class="token comment">// vec4 colorDistanceField(vec3 point,inout float minDist)</span>
<span class="token comment">// {</span>
<span class="token comment">// float charDist=MAX_DIST;</span>
<span class="token comment">// vec4 charfield=characterField(point,charDist);</span>

<span class="token comment">// vec3 mPoint=point-vec3(7.5,0.,2.);</span>
<span class="token comment">// pMod2(mPoint.xz,vec2(15.,15.));</span>

<span class="token comment">// float hexaHeight=3.;</span>
<span class="token comment">// float hexaDist=fHexagonCircumcircle(mPoint,vec2(1.5,hexaHeight));</span>
<span class="token comment">// float distPlane=fPlane(plane,point);</span>
<span class="token comment">// minDist=min(minDist,distPlane);</span>
<span class="token comment">// minDist=min(minDist,charDist);</span>
<span class="token comment">// minDist=min(minDist,hexaDist);</span>

<span class="token comment">// //blend colors</span>
<span class="token comment">// vec4 color=vec4(0.);</span>
<span class="token comment">// color+=groundColor*step(distPlane,minDist);</span>
<span class="token comment">// color+=groundColor*step(hexaDist,minDist);</span>
<span class="token comment">// color+=charfield*step(charDist,minDist);</span>

<span class="token comment">// return color;</span>
<span class="token comment">// }</span>

<span class="token comment">// //get distance and color to nearest surface</span>
<span class="token comment">// float distanceField(vec3 point)</span>
<span class="token comment">// {</span>
<span class="token comment">// float minDist=MAX_DIST;</span>
<span class="token comment">// colorDistanceField(point,minDist);</span>
<span class="token comment">// return minDist;</span>
<span class="token comment">// }</span>

<span class="token comment">// vec3 computeNormal(vec3 p,float roughness,out float ao)</span>
<span class="token comment">// {</span>
<span class="token comment">// vec3 normalWS=vec3(0.);</span>
<span class="token comment">// for(int i=min(0,u_frame);i&lt;4;i++)</span>
<span class="token comment">// {</span>
<span class="token comment">// vec3 e=.5773*(2.*vec3((((i+3)&gt;&gt;1)&amp;1),((i&gt;&gt;1)&amp;1),(i&amp;1))-1.);</span>
<span class="token comment">// uint unusedMatId;</span>
<span class="token comment">// normalWS+=e*distanceField(p+e*.001);</span>
<span class="token comment">// }</span>
<span class="token comment">// normalWS=normalize(normalWS);</span>
<span class="token comment">// vec3 deform=noise3(p*.0002);</span>

<span class="token comment">// ao=length(deform);</span>
<span class="token comment">// deform=deform*2.-vec3(1.);</span>
<span class="token comment">// return normalize(normalWS+deform*roughness*.0001);</span>
<span class="token comment">// }</span>

<span class="token comment">// vec3 computeSaberLightDir(vec3 point,StickmanData data,FieldData fieldData)</span>
<span class="token comment">// {</span>
<span class="token comment">// #if LIGHT_QUALITY</span>
<span class="token comment">// float grad=.75;</span>

<span class="token comment">// vec3 normalWS=vec3(0.);</span>
<span class="token comment">// for(int i=min(0,u_frame);i&lt;4;i++)</span>
<span class="token comment">// {</span>
<span class="token comment">// vec3 e=.5773*(2.*vec3((((i+3)&gt;&gt;1)&amp;1),((i&gt;&gt;1)&amp;1),(i&amp;1))-1.);</span>
<span class="token comment">// uint unusedMatId;</span>
<span class="token comment">// vec3 p=point+e*grad;</span>
<span class="token comment">// normalWS+=e*fSaber(data.invStickmanRot*(p-data.stickmanPos),data,fieldData);</span>
<span class="token comment">// }</span>
<span class="token comment">// normalWS=-normalize(normalWS);</span>
<span class="token comment">// return normalWS;</span>
<span class="token comment">// #else</span>
<span class="token comment">// vec3 s=(vec3(0.,data.saberLen*2.,0.)*data.invSaberRot);</span>
<span class="token comment">// vec3 a=data.stickmanPos+(data.bodyPos+data.saberPos*data.bodyDeform)*data.invStickmanRot;</span>
<span class="token comment">// vec3 c=data.stickmanPos+(data.bodyPos+(s+data.saberPos)*data.bodyDeform)*data.invStickmanRot;</span>
<span class="token comment">// return normalize(mix(a,c,.5)-point);</span>
<span class="token comment">// #endif</span>
<span class="token comment">// }</span>

<span class="token comment">// float distBetweenSabers(StickmanData first,StickmanData secnd,FieldData secndField)</span>
<span class="token comment">// {</span>
<span class="token comment">// vec3 s=(vec3(0.,first.saberLen*2.,0.)*first.invSaberRot);</span>
<span class="token comment">// vec3 a=first.stickmanPos+(first.bodyPos+first.saberPos*first.bodyDeform)*first.invStickmanRot;</span>
<span class="token comment">// vec3 c=first.stickmanPos+(first.bodyPos+(s+first.saberPos)*first.bodyDeform)*first.invStickmanRot;</span>

<span class="token comment">// float sithDistLaser=1000.;</span>
<span class="token comment">// for(float i=0.;i&lt;=1.;i+=1./32.)</span>
<span class="token comment">// {</span>
<span class="token comment">// vec3 b=mix(a,c,i);</span>
<span class="token comment">// vec3 stickmanDiff=secnd.invStickmanRot*(b-secnd.stickmanPos);</span>
<span class="token comment">// sithDistLaser=min(sithDistLaser,fSaber(stickmanDiff,secnd,secndField));</span>
<span class="token comment">// }</span>

<span class="token comment">// return sithDistLaser;</span>
<span class="token comment">// }</span>

<span class="token comment">// vec3 doLighting(vec3 surfColor,vec3 surfPoint,vec3 surfNormal,vec3 lightColor,vec3 lightDir,float roughness)</span>
<span class="token comment">// {</span>
<span class="token comment">// if(dot(surfColor,surfColor)&lt;=2.5)</span>
<span class="token comment">// {</span>
<span class="token comment">// float lightingWrap=.5;</span>
<span class="token comment">// float diff=dot(surfNormal,lightDir);</span>
<span class="token comment">// diff=clamp((diff+lightingWrap)/((1.+lightingWrap)*(1.+lightingWrap)),0.,1.);</span>
<span class="token comment">// vec3 eyeDir=normalize(projectionCenter-surfPoint);</span>
<span class="token comment">// vec3 halfVec=normalize(eyeDir+lightDir);</span>
<span class="token comment">// float spec=clamp(dot(halfVec,surfNormal),0.,1.);</span>
<span class="token comment">// spec=pow(spec,mix(128.,8.,pow(roughness,.5)))*pow(diff,1.);</span>
<span class="token comment">// surfColor=surfColor*diff*lightColor+lightColor*spec;</span>
<span class="token comment">// }</span>
<span class="token comment">// return surfColor;</span>
<span class="token comment">// }</span>

<span class="token comment">// //raymarch and sample atmosphere color along the ray</span>
<span class="token comment">// vec4 rmAtmosphere(vec3 rayStart,vec3 rayDir,float minDist)</span>
<span class="token comment">// {</span>
<span class="token comment">// float cloud=0.;</span>
<span class="token comment">// float transmittance=1.;</span>
<span class="token comment">// vec3 scatteredLight=vec3(0.,0.,0.);</span>

<span class="token comment">// float totalDist=minDist;</span>
<span class="token comment">// float dist=0.;</span>
<span class="token comment">// float dStep=0.;</span>
<span class="token comment">// vec3 color=zero;</span>
<span class="token comment">// float stepBias,jediDistLaser,sithDistLaser,strLaser;</span>
<span class="token comment">// vec3 atmColor,surfColor,litColor;</span>
<span class="token comment">// vec3 endPoint,sithStickmanDiff,jediStickmanDiff,normal;</span>
<span class="token comment">// vec3 jediSaberLightDir,sithSaberLightDir;</span>
<span class="token comment">// vec4 dfRes;</span>
<span class="token comment">// float roughness=.0;</span>
<span class="token comment">// vec3 S,Sint;</span>
<span class="token comment">// float saberOverlap;</span>

<span class="token comment">// float distSab=distBetweenSabers(jediData,sithData,sithFieldData);</span>
<span class="token comment">// //distSab = min(distSab, distBetweenSabers(sithData, jediData, jediFieldData));</span>
<span class="token comment">// float contactLightPower=1.+smoothstep(.3,.15,distSab)*3.;</span>

<span class="token comment">// vec4 rmRes;</span>

<span class="token comment">// for(int i=0;i&lt;MAX_STEPS;++i)</span>
<span class="token comment">// {</span>
<span class="token comment">// stepBias=max(MIN_STEP_BIAS,totalDist*2./MAX_DIST);//to avoid artefacts</span>

<span class="token comment">// endPoint=rayStart+rayDir*totalDist;</span>
<span class="token comment">// jediStickmanDiff=jediData.invStickmanRot*(endPoint-jediData.stickmanPos);</span>
<span class="token comment">// jediFieldData.fSaber=fSaber(jediStickmanDiff,jediData,jediFieldData);</span>
<span class="token comment">// strLaser=1.+smoothstep(jediData.saberLen*2.,0.,fHandle(jediStickmanDiff,jediData,jediFieldData))*2.;</span>
<span class="token comment">// jediDistLaser=(LASER_STR+strLaser)/pow(jediFieldData.fSaber,2.);</span>

<span class="token comment">// #ifdef TWO_EGGS</span>
<span class="token comment">// sithStickmanDiff=sithData.invStickmanRot*(endPoint-sithData.stickmanPos);</span>
<span class="token comment">// sithFieldData.fSaber=fSaber(sithStickmanDiff,sithData,sithFieldData);</span>
<span class="token comment">// strLaser=1.+smoothstep(sithData.saberLen*2.,0.,fHandle(sithStickmanDiff,sithData,sithFieldData))*2.;</span>
<span class="token comment">// sithDistLaser=(LASER_STR+strLaser)/pow(sithFieldData.fSaber,2.);</span>

<span class="token comment">// saberOverlap=1./pow(jediFieldData.fSaber*sithFieldData.fSaber,1.5);</span>
<span class="token comment">// jediDistLaser+=saberOverlap;</span>
<span class="token comment">// sithDistLaser+=saberOverlap;</span>
<span class="token comment">// #endif</span>

<span class="token comment">// jediSaberLightDir=computeSaberLightDir(endPoint,jediData,jediFieldData);</span>
<span class="token comment">// sithSaberLightDir=computeSaberLightDir(endPoint,sithData,sithFieldData);</span>

<span class="token comment">// #if VOL_FOG</span>
<span class="token comment">// vec3 atmSamplePos=endPoint+rayDir*dist*(s_pixelRand-.5);</span>
<span class="token comment">// cloud=atmThickness(atmSamplePos);</span>

<span class="token comment">// S=jediDistLaser*jediData.laserLight*contactLightPower*</span>
<span class="token comment">// #if VOL_SHADOW</span>
<span class="token comment">// volumetricShadow(atmSamplePos,jediSaberLightDir)*</span>
<span class="token comment">// #endif</span>
<span class="token comment">// cloud*PHASE_FUNC;// incoming light</span>
<span class="token comment">// #ifdef TWO_EGGS</span>
<span class="token comment">// S+=sithDistLaser*sithData.laserLight*contactLightPower*</span>
<span class="token comment">// #if VOL_SHADOW</span>
<span class="token comment">// volumetricShadow(atmSamplePos,sithSaberLightDir)*</span>
<span class="token comment">// #endif</span>
<span class="token comment">// cloud*PHASE_FUNC;// incoming light</span>
<span class="token comment">// #endif</span>

<span class="token comment">// Sint=(S-S*exp(-cloud*dStep))/cloud;// integrate along the current step segment</span>
<span class="token comment">// scatteredLight+=transmittance*Sint;// accumulate and also take into account the transmittance from previous steps</span>
<span class="token comment">// // Evaluate transmittance to view independentely</span>
<span class="token comment">// transmittance*=exp(-cloud*dStep);</span>
<span class="token comment">// if(transmittance&lt;.005)</span>
<span class="token comment">// {</span>
<span class="token comment">// break;</span>
<span class="token comment">// }</span>
<span class="token comment">// #endif</span>
<span class="token comment">// dist=MAX_DIST;</span>
<span class="token comment">// dfRes=colorDistanceField(endPoint,dist);</span>
<span class="token comment">// dStep=dist*stepBias;</span>
<span class="token comment">// totalDist+=dStep;</span>

<span class="token comment">// if(dist&lt;=MIN_DIST)</span>
<span class="token comment">// {</span>
<span class="token comment">// float ao=1.;</span>
<span class="token comment">// normal=computeNormal(endPoint,roughness,ao);</span>
<span class="token comment">// //store final hit color</span>
<span class="token comment">// surfColor=dfRes.xyz;</span>
<span class="token comment">// roughness=dfRes.w;</span>

<span class="token comment">// //do lighting</span>
<span class="token comment">// litColor=AMBIANT_LIGHT*surfColor;</span>
<span class="token comment">// //Don&#39;t do sunlight, night time looks better</span>
<span class="token comment">// //litColor += doLighting(surfColor, endPoint, normal, sunLightColor, normalize(sunLightPos - endPoint), roughness);</span>

<span class="token comment">// litColor+=doLighting(surfColor,endPoint,normal,</span>
<span class="token comment">// (jediData.laserLight*contactLightPower)*jediDistLaser*.5,</span>
<span class="token comment">// jediSaberLightDir,roughness);</span>
<span class="token comment">// #ifdef TWO_EGGS</span>

<span class="token comment">// litColor+=doLighting(surfColor,endPoint,normal,</span>
<span class="token comment">// (sithData.laserLight*contactLightPower)*sithDistLaser*.5,</span>
<span class="token comment">// sithSaberLightDir,roughness);</span>
<span class="token comment">// #endif</span>

<span class="token comment">// color=surfColor*ao*.01+litColor;</span>

<span class="token comment">// rmRes=vec4(color,totalDist);</span>
<span class="token comment">// break;</span>
<span class="token comment">// }</span>

<span class="token comment">// //no surface hit, return sky + atmColor</span>
<span class="token comment">// if(totalDist&gt;=MAX_DIST||i&gt;=MAX_STEPS-1)</span>
<span class="token comment">// {</span>
<span class="token comment">// rmRes=vec4(color+skyColor,MAX_DIST+.01);</span>
<span class="token comment">// break;</span>
<span class="token comment">// }</span>
<span class="token comment">// }</span>

<span class="token comment">// rmRes.xyz=mix(fogColor*.8,rmRes.xyz,transmittance)+scatteredLight;</span>
<span class="token comment">// return rmRes;</span>
<span class="token comment">// }</span>

<span class="token comment">// void main()</span>
<span class="token comment">// {</span>
<span class="token comment">// s_pixelRand=texture2D(iChannel0,gl_FragCoord/vec2(1024.),0.).r;</span>
<span class="token comment">// s_pixelRand=fract(s_pixelRand+float(u_frame%256)*1.618);</span>
<span class="token comment">// s_time=u_time;</span>

<span class="token comment">// vec2 mousePos=u_mouse.xy/u_resolution.xy*2.-vec2(1.);</span>
<span class="token comment">// float day=0.;</span>
<span class="token comment">// day=sign(day)*pow(abs(day),2.);</span>
<span class="token comment">// dayProgress=abs(day);</span>

<span class="token comment">// float sunsetFromNight=smoothstep(.4,.5,dayProgress);</span>
<span class="token comment">// float sunsetToDay=smoothstep(.8,.5,dayProgress);</span>
<span class="token comment">// vec3 sunsetColor=mix(mix(vec3(.5,0.,0.),vec3(1.,.8,.3),sunsetFromNight),</span>
<span class="token comment">// mix(vec3(.2,.2,1.),vec3(1.,.8,.3),sunsetToDay),(sunsetFromNight+sunsetToDay)/2.);</span>
<span class="token comment">// float sunsetStr=sunsetFromNight*sunsetToDay;</span>

<span class="token comment">// sunLightPos=vec3(0.,-1000.,0.);</span>
<span class="token comment">// mat3 sRotZ;</span>
<span class="token comment">// rotationZ(day*PI,sRotZ);</span>
<span class="token comment">// sunLightPos=sRotZ*sunLightPos;</span>

<span class="token comment">// sunLightColor=mix(vec3(.004,.004,.0065),vec3(.8,.8,.7),dayProgress);</span>
<span class="token comment">// sunLightColor=mix(sunLightColor,sunsetColor,sunsetStr);</span>

<span class="token comment">// vec2 uv=gl_FragCoord.xy/u_resolution;</span>
<span class="token comment">// vec3 ro=vec3(0.);</span>

<span class="token comment">// float t=s_time*1.1;</span>
<span class="token comment">// t+=(cos(t*.5))*.2;</span>

<span class="token comment">// float camT=t*.5;</span>
<span class="token comment">// float camRotY=(mousePos.x+camT*.1)*PI*-2.;</span>
<span class="token comment">// float camY=(1.-cos(camT*.5))*.3;</span>
<span class="token comment">// float camDist=12.-sin(camT*.5)*4.;</span>

<span class="token comment">// //animate before marching</span>
<span class="token comment">// initStickman(jediData,true);</span>
<span class="token comment">// #ifdef TWO_EGGS</span>
<span class="token comment">// jediData.stickmanPos.x+=2.7;</span>
<span class="token comment">// mat3 yRot;</span>
<span class="token comment">// rotationY(-.5*PI,yRot);</span>
<span class="token comment">// jediData.invStickmanRot=yRot*jediData.invStickmanRot;</span>

<span class="token comment">// initStickman(sithData,false);</span>
<span class="token comment">// sithData.stickmanPos.x-=2.7;</span>
<span class="token comment">// rotationY(.5*PI,yRot);</span>
<span class="token comment">// sithData.invStickmanRot=yRot*sithData.invStickmanRot;</span>
<span class="token comment">// animateSith(t,sithData);</span>
<span class="token comment">// computeFieldData(sithData,sithFieldData);</span>
<span class="token comment">// #endif</span>
<span class="token comment">// animateJedi(t,jediData);</span>
<span class="token comment">// computeFieldData(jediData,jediFieldData);</span>

<span class="token comment">// //////////////////</span>

<span class="token comment">// //Do camera setup from mouse coord</span>
<span class="token comment">// vec3 pCenter=vec3(0.,.2,0.);</span>
<span class="token comment">// vec3 pOffset=vec3(0.,0.,1.);</span>

<span class="token comment">// mat3 pRotY;</span>
<span class="token comment">// rotationY(camRotY,pRotY);</span>
<span class="token comment">// pOffset.y=camY;</span>
<span class="token comment">// pOffset=pRotY*pOffset;</span>
<span class="token comment">// projectionCenter=pCenter+pOffset*camDist;</span>

<span class="token comment">// vec3 tmpCenter=(projectionCenter+vec3(0.,0.,.50));</span>

<span class="token comment">// projectionCenter=(projectionCenter);</span>

<span class="token comment">// projectionForward=normalize(-pOffset);</span>
<span class="token comment">// projectionUp=vec3(0.,1.,0.);</span>
<span class="token comment">// projectionRight=cross(projectionUp,projectionForward);</span>
<span class="token comment">// projectionUp=cross(projectionForward,projectionRight);</span>
<span class="token comment">// mousePos=pixelToNormalizedspace(u_mouse.xy);</span>

<span class="token comment">// cameraOffset=-projectionForward*FOCAL_LENGTH;</span>

<span class="token comment">// vec2 rd=uv*2.-vec2(1.);</span>
<span class="token comment">// rd.y/=u_resolution.x/u_resolution.y;</span>
<span class="token comment">// //setup ray</span>
<span class="token comment">// vec3 rayPos=projectionCenter+cameraOffset;</span>
<span class="token comment">// vec3 pointOnProjectionPlane=projectionCenter+projectionRight*rd.x+projectionUp*rd.y;</span>
<span class="token comment">// vec3 rayDirection=normalize(pointOnProjectionPlane-rayPos);</span>

<span class="token comment">// float sun=pow(max(0.,dot(rayDirection,normalize(sunLightPos))),2.);</span>

<span class="token comment">// //sky and stars</span>
<span class="token comment">// vec2 xzDir=normalize(rayDirection.xz);</span>
<span class="token comment">// vec2 starsUv=vec2(atan(xzDir.x,xzDir.y),rayDirection.y);</span>
<span class="token comment">// vec3 stars=texture2D(iChannel0,starsUv*0.1,0.).xyz;</span>
<span class="token comment">// stars*=pow(dot(stars,stars)*.5,16.)*.3;// smoothstep(2.1, 2.5, dot(stars, stars));</span>
<span class="token comment">// stars=smoothstep(vec3(0.),vec3(1.),stars);</span>
<span class="token comment">// float skyHeight=pow(max(0.,rayDirection.y)*2.,.75);</span>
<span class="token comment">// float starVis=skyHeight*pow(1.-dayProgress,2.);</span>
<span class="token comment">// stars=mix(zero,stars,pow(starVis,6.));</span>

<span class="token comment">// vec3 lowColor=mix(vec3(.01,.01,.05),vec3(.85,.85,1.),dayProgress);</span>
<span class="token comment">// lowColor=mix(lowColor,sunsetColor,sunsetStr+pow(sun,5.)*sunsetStr*2.);</span>
<span class="token comment">// vec3 upColor=mix(vec3(.0005,.0005,.001),vec3(.15,.15,1.),dayProgress);</span>
<span class="token comment">// upColor=mix(upColor,sunsetColor,sunsetStr*.5+pow(sun,5.)*sunsetStr*2.);</span>

<span class="token comment">// skyColor=mix(lowColor,upColor,skyHeight);</span>

<span class="token comment">// float fogBlur=.5;</span>
<span class="token comment">// fogColor=mix(mix(lowColor,upColor,max(0.,skyHeight-fogBlur)),</span>
<span class="token comment">// mix(lowColor,upColor,min(1.,skyHeight+fogBlur)),</span>
<span class="token comment">// .5);</span>

<span class="token comment">// //march ray</span>
<span class="token comment">// vec4 rayMarchResult=rmAtmosphere(rayPos,rayDirection,0.);</span>
<span class="token comment">// float dist=rayMarchResult.w;</span>
<span class="token comment">// vec4 surfaceColor=vec4(rayMarchResult.xyz,1.);</span>

<span class="token comment">// if(dist&gt;=MAX_DIST)</span>
<span class="token comment">// {</span>
<span class="token comment">// surfaceColor.xyz+=stars;</span>
<span class="token comment">// surfaceColor.xyz=surfaceColor.xyz+sunLightColor*pow(sun,80.)*10.;</span>
<span class="token comment">// }</span>

<span class="token comment">// //convert to gamma space</span>
<span class="token comment">// surfaceColor=pow(surfaceColor,vec4(1./2.2));</span>
<span class="token comment">// gl_FragColor=surfaceColor;</span>
<span class="token comment">// }</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">float</span> bug<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>
  <span class="token keyword">vec3</span> tile<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>iChannel0<span class="token punctuation">,</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">/</span>u_resolution<span class="token punctuation">,</span><span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
  <span class="token keyword">vec4</span> col<span class="token operator">=</span><span class="token keyword">vec4</span><span class="token punctuation">(</span>tile<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//if(....)</span>
  bug<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">;</span>
  col<span class="token punctuation">.</span>x<span class="token operator">+=</span>bug<span class="token punctuation">;</span>
  gl_FragColor<span class="token operator">=</span>col<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1)),s("h3",v,[n[10]||(n[10]=s("a",{class:"header-anchor",href:"#primitives","aria-hidden":"true"},"#",-1)),n[11]||(n[11]=a()),o(t,{to:"/markdown/example/primitives.html"},{default:e(()=>n[9]||(n[9]=[a("primitives")])),_:1})]),n[22]||(n[22]=p(`<div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code>
<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_color<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_frame<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_mouse<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_resolution<span class="token punctuation">;</span>
<span class="token comment">//\u4F20\u9012\u957F\u548C\u5BBD</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_time<span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> vUv<span class="token punctuation">;</span>



<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AA</span> <span class="token expression"><span class="token number">3</span>   </span><span class="token comment">// make this 2 or 3 for antialiasing</span></span>

<span class="token comment">//------------------------------------------------------------------</span>
<span class="token keyword">float</span> <span class="token function">dot2</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> v <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">dot</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">float</span> <span class="token function">dot2</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> v <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">dot</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">float</span> <span class="token function">ndot</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> b <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a<span class="token punctuation">.</span>x<span class="token operator">*</span>b<span class="token punctuation">.</span>x <span class="token operator">-</span> a<span class="token punctuation">.</span>y<span class="token operator">*</span>b<span class="token punctuation">.</span>y<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdPlane</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span> p <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> p<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdSphere</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">float</span> s <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-</span>s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdBox</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> b <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> b<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>y<span class="token punctuation">,</span>d<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// float min(float x,float y){</span>
<span class="token comment">//     #if x&gt;y</span>
<span class="token comment">//     return y</span>
<span class="token comment">//     #else </span>
<span class="token comment">//     return x</span>
<span class="token comment">//     #endif</span>
<span class="token comment">// }</span>

<span class="token keyword">float</span> <span class="token function">sdBoxFrame</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> b<span class="token punctuation">,</span> <span class="token keyword">float</span> e <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
       p <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p  <span class="token punctuation">)</span><span class="token operator">-</span>b<span class="token punctuation">;</span>
  <span class="token keyword">vec3</span> q <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token operator">+</span>e<span class="token punctuation">)</span><span class="token operator">-</span>e<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>
      <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span>q<span class="token punctuation">.</span>y<span class="token punctuation">,</span>q<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>y<span class="token punctuation">,</span>q<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span>q<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span>q<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span>q<span class="token punctuation">.</span>y<span class="token punctuation">,</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>y<span class="token punctuation">,</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">float</span> <span class="token function">sdEllipsoid</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> r <span class="token punctuation">)</span> <span class="token comment">// approximated</span>
<span class="token punctuation">{</span>
    <span class="token keyword">float</span> k0 <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token operator">/</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> k1 <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">*</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> k0<span class="token operator">*</span><span class="token punctuation">(</span>k0<span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token operator">/</span>k1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdTorus</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec2</span> t <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token operator">-</span>t<span class="token punctuation">.</span>x<span class="token punctuation">,</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">-</span>t<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdCappedTorus</span><span class="token punctuation">(</span><span class="token keyword">in</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> sc<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> ra<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> rb<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    p<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token punctuation">(</span>sc<span class="token punctuation">.</span>y<span class="token operator">*</span>p<span class="token punctuation">.</span>x<span class="token operator">&gt;</span>sc<span class="token punctuation">.</span>x<span class="token operator">*</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">dot</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">,</span>sc<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span> <span class="token function">dot</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>p<span class="token punctuation">)</span> <span class="token operator">+</span> ra<span class="token operator">*</span>ra <span class="token operator">-</span> <span class="token number">2.0</span><span class="token operator">*</span>ra<span class="token operator">*</span>k <span class="token punctuation">)</span> <span class="token operator">-</span> rb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdHexPrism</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec2</span> h <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> q <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">vec3</span> k <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.8660254</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.57735</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>xy <span class="token operator">-=</span> <span class="token number">2.0</span><span class="token operator">*</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> p<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">*</span>k<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> d <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>
       <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy <span class="token operator">-</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">clamp</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">-</span>k<span class="token punctuation">.</span>z<span class="token operator">*</span>h<span class="token punctuation">.</span>x<span class="token punctuation">,</span> k<span class="token punctuation">.</span>z<span class="token operator">*</span>h<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">sign</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y <span class="token operator">-</span> h<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
       p<span class="token punctuation">.</span>z<span class="token operator">-</span>h<span class="token punctuation">.</span>y <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span>d<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdOctogonPrism</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> r<span class="token punctuation">,</span> <span class="token keyword">float</span> h <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">vec3</span> k <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.9238795325</span><span class="token punctuation">,</span>   <span class="token comment">// sqrt(2+sqrt(2))/2 </span>
                       <span class="token number">0.3826834323</span><span class="token punctuation">,</span>   <span class="token comment">// sqrt(2-sqrt(2))/2</span>
                       <span class="token number">0.4142135623</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sqrt(2)-1 </span>
  <span class="token comment">// reflections</span>
  p <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token punctuation">.</span>xy <span class="token operator">-=</span> <span class="token number">2.0</span><span class="token operator">*</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span><span class="token keyword">vec2</span><span class="token punctuation">(</span> k<span class="token punctuation">.</span>x<span class="token punctuation">,</span>k<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token keyword">vec2</span><span class="token punctuation">(</span> k<span class="token punctuation">.</span>x<span class="token punctuation">,</span>k<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token punctuation">.</span>xy <span class="token operator">-=</span> <span class="token number">2.0</span><span class="token operator">*</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>k<span class="token punctuation">.</span>x<span class="token punctuation">,</span>k<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>k<span class="token punctuation">.</span>x<span class="token punctuation">,</span>k<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// polygon side</span>
  p<span class="token punctuation">.</span>xy <span class="token operator">-=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">clamp</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">-</span>k<span class="token punctuation">.</span>z<span class="token operator">*</span>r<span class="token punctuation">,</span> k<span class="token punctuation">.</span>z<span class="token operator">*</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">vec2</span> d <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">sign</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token operator">-</span>h <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span>d<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdCapsule</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> a<span class="token punctuation">,</span> <span class="token keyword">vec3</span> b<span class="token punctuation">,</span> <span class="token keyword">float</span> r <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">vec3</span> pa <span class="token operator">=</span> p<span class="token operator">-</span>a<span class="token punctuation">,</span> ba <span class="token operator">=</span> b<span class="token operator">-</span>a<span class="token punctuation">;</span>
	<span class="token keyword">float</span> h <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token function">dot</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span>ba<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">dot</span><span class="token punctuation">(</span>ba<span class="token punctuation">,</span>ba<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span> pa <span class="token operator">-</span> ba<span class="token operator">*</span>h <span class="token punctuation">)</span> <span class="token operator">-</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdRoundCone</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> r1<span class="token punctuation">,</span> <span class="token keyword">float</span> r2<span class="token punctuation">,</span> <span class="token keyword">float</span> h <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> q <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">float</span> b <span class="token operator">=</span> <span class="token punctuation">(</span>r1<span class="token operator">-</span>r2<span class="token punctuation">)</span><span class="token operator">/</span>h<span class="token punctuation">;</span>
    <span class="token keyword">float</span> a <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">-</span>b<span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>b<span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span> k <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token operator">-</span> r1<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> k <span class="token operator">&gt;</span> a<span class="token operator">*</span>h <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>q<span class="token operator">-</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> r2<span class="token punctuation">;</span>
        
    <span class="token keyword">return</span> <span class="token function">dot</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">-</span> r1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdRoundCone</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> a<span class="token punctuation">,</span> <span class="token keyword">vec3</span> b<span class="token punctuation">,</span> <span class="token keyword">float</span> r1<span class="token punctuation">,</span> <span class="token keyword">float</span> r2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// sampling independent computations (only depend on shape)</span>
    <span class="token keyword">vec3</span>  ba <span class="token operator">=</span> b <span class="token operator">-</span> a<span class="token punctuation">;</span>
    <span class="token keyword">float</span> l2 <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>ba<span class="token punctuation">,</span>ba<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> rr <span class="token operator">=</span> r1 <span class="token operator">-</span> r2<span class="token punctuation">;</span>
    <span class="token keyword">float</span> a2 <span class="token operator">=</span> l2 <span class="token operator">-</span> rr<span class="token operator">*</span>rr<span class="token punctuation">;</span>
    <span class="token keyword">float</span> il2 <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span>l2<span class="token punctuation">;</span>
    
    <span class="token comment">// sampling dependant computations</span>
    <span class="token keyword">vec3</span> pa <span class="token operator">=</span> p <span class="token operator">-</span> a<span class="token punctuation">;</span>
    <span class="token keyword">float</span> y <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span>ba<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> z <span class="token operator">=</span> y <span class="token operator">-</span> l2<span class="token punctuation">;</span>
    <span class="token keyword">float</span> x2 <span class="token operator">=</span> <span class="token function">dot2</span><span class="token punctuation">(</span> pa<span class="token operator">*</span>l2 <span class="token operator">-</span> ba<span class="token operator">*</span>y <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> y2 <span class="token operator">=</span> y<span class="token operator">*</span>y<span class="token operator">*</span>l2<span class="token punctuation">;</span>
    <span class="token keyword">float</span> z2 <span class="token operator">=</span> z<span class="token operator">*</span>z<span class="token operator">*</span>l2<span class="token punctuation">;</span>

    <span class="token comment">// single square root!</span>
    <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token function">sign</span><span class="token punctuation">(</span>rr<span class="token punctuation">)</span><span class="token operator">*</span>rr<span class="token operator">*</span>rr<span class="token operator">*</span>x2<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">sign</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token operator">*</span>a2<span class="token operator">*</span>z2 <span class="token operator">&gt;</span> k <span class="token punctuation">)</span> <span class="token keyword">return</span>  <span class="token function">sqrt</span><span class="token punctuation">(</span>x2 <span class="token operator">+</span> z2<span class="token punctuation">)</span>        <span class="token operator">*</span>il2 <span class="token operator">-</span> r2<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">sign</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token operator">*</span>a2<span class="token operator">*</span>y2 <span class="token operator">&lt;</span> k <span class="token punctuation">)</span> <span class="token keyword">return</span>  <span class="token function">sqrt</span><span class="token punctuation">(</span>x2 <span class="token operator">+</span> y2<span class="token punctuation">)</span>        <span class="token operator">*</span>il2 <span class="token operator">-</span> r1<span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x2<span class="token operator">*</span>a2<span class="token operator">*</span>il2<span class="token punctuation">)</span><span class="token operator">+</span>y<span class="token operator">*</span>rr<span class="token punctuation">)</span><span class="token operator">*</span>il2 <span class="token operator">-</span> r1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdTriPrism</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec2</span> h <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    h<span class="token punctuation">.</span>x <span class="token operator">*=</span> <span class="token number">0.5</span><span class="token operator">*</span>k<span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>xy <span class="token operator">/=</span> h<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>y <span class="token operator">=</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1.0</span><span class="token operator">/</span>k<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> p<span class="token punctuation">.</span>x<span class="token operator">+</span>k<span class="token operator">*</span>p<span class="token punctuation">.</span>y<span class="token operator">&gt;</span><span class="token number">0.0</span> <span class="token punctuation">)</span> p<span class="token punctuation">.</span>xy<span class="token operator">=</span><span class="token keyword">vec2</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">-</span>k<span class="token operator">*</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span><span class="token operator">-</span>k<span class="token operator">*</span>p<span class="token punctuation">.</span>x<span class="token operator">-</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>x <span class="token operator">-=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> d1 <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token operator">-</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">*</span>h<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">float</span> d2 <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token operator">-</span>h<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">vec2</span><span class="token punctuation">(</span>d1<span class="token punctuation">,</span>d2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d1<span class="token punctuation">,</span>d2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// vertical</span>
<span class="token keyword">float</span> <span class="token function">sdCylinder</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec2</span> h <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token punctuation">,</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> h<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span>d<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// arbitrary orientation</span>
<span class="token keyword">float</span> <span class="token function">sdCylinder</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> a<span class="token punctuation">,</span> <span class="token keyword">vec3</span> b<span class="token punctuation">,</span> <span class="token keyword">float</span> r<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> pa <span class="token operator">=</span> p <span class="token operator">-</span> a<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> ba <span class="token operator">=</span> b <span class="token operator">-</span> a<span class="token punctuation">;</span>
    <span class="token keyword">float</span> baba <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>ba<span class="token punctuation">,</span>ba<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> paba <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span>ba<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> x <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>pa<span class="token operator">*</span>baba<span class="token operator">-</span>ba<span class="token operator">*</span>paba<span class="token punctuation">)</span> <span class="token operator">-</span> r<span class="token operator">*</span>baba<span class="token punctuation">;</span>
    <span class="token keyword">float</span> y <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>paba<span class="token operator">-</span>baba<span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">-</span>baba<span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> x2 <span class="token operator">=</span> x<span class="token operator">*</span>x<span class="token punctuation">;</span>
    <span class="token keyword">float</span> y2 <span class="token operator">=</span> y<span class="token operator">*</span>y<span class="token operator">*</span>baba<span class="token punctuation">;</span>
    <span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token operator">-</span><span class="token function">min</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span>y2<span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">&gt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">?</span>x2<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token operator">&gt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">?</span>y2<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">sign</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>baba<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// vertical</span>
<span class="token keyword">float</span> <span class="token function">sdCone</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> c<span class="token punctuation">,</span> <span class="token keyword">float</span> h <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> q <span class="token operator">=</span> h<span class="token operator">*</span><span class="token keyword">vec2</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>x<span class="token punctuation">,</span><span class="token operator">-</span>c<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">/</span>c<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> w <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token keyword">vec2</span> a <span class="token operator">=</span> w <span class="token operator">-</span> q<span class="token operator">*</span><span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token function">dot</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span>q<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">dot</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span>q<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> b <span class="token operator">=</span> w <span class="token operator">-</span> q<span class="token operator">*</span><span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">clamp</span><span class="token punctuation">(</span> w<span class="token punctuation">.</span>x<span class="token operator">/</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token function">sign</span><span class="token punctuation">(</span> q<span class="token punctuation">.</span>y <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span> a<span class="token punctuation">,</span> a <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">dot</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> s <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span> k<span class="token operator">*</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>x<span class="token operator">*</span>q<span class="token punctuation">.</span>y<span class="token operator">-</span>w<span class="token punctuation">.</span>y<span class="token operator">*</span>q<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>k<span class="token operator">*</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>y<span class="token operator">-</span>q<span class="token punctuation">.</span>y<span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">sign</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdCappedCone</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> h<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> r1<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> r2 <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> q <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">vec2</span> k1 <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>r2<span class="token punctuation">,</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> k2 <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>r2<span class="token operator">-</span>r1<span class="token punctuation">,</span><span class="token number">2.0</span><span class="token operator">*</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> ca <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token operator">-</span><span class="token function">min</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">?</span>r1<span class="token operator">:</span>r2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">-</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> cb <span class="token operator">=</span> q <span class="token operator">-</span> k1 <span class="token operator">+</span> k2<span class="token operator">*</span><span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token function">dot</span><span class="token punctuation">(</span>k1<span class="token operator">-</span>q<span class="token punctuation">,</span>k2<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">dot2</span><span class="token punctuation">(</span>k2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> s <span class="token operator">=</span> <span class="token punctuation">(</span>cb<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span> ca<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1.0</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token operator">*</span><span class="token function">sqrt</span><span class="token punctuation">(</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">dot2</span><span class="token punctuation">(</span>ca<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">dot2</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdCappedCone</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> a<span class="token punctuation">,</span> <span class="token keyword">vec3</span> b<span class="token punctuation">,</span> <span class="token keyword">float</span> ra<span class="token punctuation">,</span> <span class="token keyword">float</span> rb<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">float</span> rba  <span class="token operator">=</span> rb<span class="token operator">-</span>ra<span class="token punctuation">;</span>
    <span class="token keyword">float</span> baba <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>b<span class="token operator">-</span>a<span class="token punctuation">,</span>b<span class="token operator">-</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> papa <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>p<span class="token operator">-</span>a<span class="token punctuation">,</span>p<span class="token operator">-</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> paba <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>p<span class="token operator">-</span>a<span class="token punctuation">,</span>b<span class="token operator">-</span>a<span class="token punctuation">)</span><span class="token operator">/</span>baba<span class="token punctuation">;</span>

    <span class="token keyword">float</span> x <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span> papa <span class="token operator">-</span> paba<span class="token operator">*</span>paba<span class="token operator">*</span>baba <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> cax <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span>x<span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span>paba<span class="token operator">&lt;</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">?</span>ra<span class="token operator">:</span>rb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> cay <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>paba<span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> k <span class="token operator">=</span> rba<span class="token operator">*</span>rba <span class="token operator">+</span> baba<span class="token punctuation">;</span>
    <span class="token keyword">float</span> f <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>rba<span class="token operator">*</span><span class="token punctuation">(</span>x<span class="token operator">-</span>ra<span class="token punctuation">)</span><span class="token operator">+</span>paba<span class="token operator">*</span>baba<span class="token punctuation">)</span><span class="token operator">/</span>k<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> cbx <span class="token operator">=</span> x<span class="token operator">-</span>ra <span class="token operator">-</span> f<span class="token operator">*</span>rba<span class="token punctuation">;</span>
    <span class="token keyword">float</span> cby <span class="token operator">=</span> paba <span class="token operator">-</span> f<span class="token punctuation">;</span>
    
    <span class="token keyword">float</span> s <span class="token operator">=</span> <span class="token punctuation">(</span>cbx <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span> cay <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1.0</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> s<span class="token operator">*</span><span class="token function">sqrt</span><span class="token punctuation">(</span> <span class="token function">min</span><span class="token punctuation">(</span>cax<span class="token operator">*</span>cax <span class="token operator">+</span> cay<span class="token operator">*</span>cay<span class="token operator">*</span>baba<span class="token punctuation">,</span>
                       cbx<span class="token operator">*</span>cbx <span class="token operator">+</span> cby<span class="token operator">*</span>cby<span class="token operator">*</span>baba<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// c is the sin/cos of the desired cone angle</span>
<span class="token keyword">float</span> <span class="token function">sdSolidAngle</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> pos<span class="token punctuation">,</span> <span class="token keyword">vec2</span> c<span class="token punctuation">,</span> <span class="token keyword">float</span> ra<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> p <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">length</span><span class="token punctuation">(</span>pos<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token punctuation">,</span> pos<span class="token punctuation">.</span>y <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> l <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> ra<span class="token punctuation">;</span>
	<span class="token keyword">float</span> m <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>p <span class="token operator">-</span> c<span class="token operator">*</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>ra<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">max</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span>m<span class="token operator">*</span><span class="token function">sign</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>y<span class="token operator">*</span>p<span class="token punctuation">.</span>x<span class="token operator">-</span>c<span class="token punctuation">.</span>x<span class="token operator">*</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdOctahedron</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">float</span> s<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    p <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span>x <span class="token operator">+</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> p<span class="token punctuation">.</span>z <span class="token operator">-</span> s<span class="token punctuation">;</span>

    <span class="token comment">// exact distance</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    <span class="token keyword">vec3</span> o <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">3.0</span><span class="token operator">*</span>p <span class="token operator">-</span> m<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    o <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">6.0</span><span class="token operator">*</span>p <span class="token operator">-</span> m<span class="token operator">*</span><span class="token number">2.0</span> <span class="token operator">-</span> o<span class="token operator">*</span><span class="token number">3.0</span> <span class="token operator">+</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>x<span class="token operator">+</span>o<span class="token punctuation">.</span>y<span class="token operator">+</span>o<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>p <span class="token operator">-</span> s<span class="token operator">*</span>o<span class="token operator">/</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>x<span class="token operator">+</span>o<span class="token punctuation">.</span>y<span class="token operator">+</span>o<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token comment">// exact distance</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span></span></span>
 	<span class="token keyword">vec3</span> q<span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token number">3.0</span><span class="token operator">*</span>p<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> m <span class="token punctuation">)</span> q <span class="token operator">=</span> p<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token number">3.0</span><span class="token operator">*</span>p<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> m <span class="token punctuation">)</span> q <span class="token operator">=</span> p<span class="token punctuation">.</span>yzx<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token number">3.0</span><span class="token operator">*</span>p<span class="token punctuation">.</span>z <span class="token operator">&lt;</span> m <span class="token punctuation">)</span> q <span class="token operator">=</span> p<span class="token punctuation">.</span>zxy<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> m<span class="token operator">*</span><span class="token number">0.57735027</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>z<span class="token operator">-</span>q<span class="token punctuation">.</span>y<span class="token operator">+</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span>q<span class="token punctuation">.</span>y<span class="token operator">-</span>s<span class="token operator">+</span>k<span class="token punctuation">,</span>q<span class="token punctuation">.</span>z<span class="token operator">-</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    <span class="token comment">// bound, not exact</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
	<span class="token keyword">return</span> m<span class="token operator">*</span><span class="token number">0.57735027</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdPyramid</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> h <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">float</span> m2 <span class="token operator">=</span> h<span class="token operator">*</span>h <span class="token operator">+</span> <span class="token number">0.25</span><span class="token punctuation">;</span>
    
    <span class="token comment">// symmetry</span>
    p<span class="token punctuation">.</span>xz <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>xz <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>z<span class="token operator">&gt;</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">?</span> p<span class="token punctuation">.</span>zx <span class="token operator">:</span> p<span class="token punctuation">.</span>xz<span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>xz <span class="token operator">-=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
	
    <span class="token keyword">vec3</span> q <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span> p<span class="token punctuation">.</span>z<span class="token punctuation">,</span> h<span class="token operator">*</span>p<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">0.5</span><span class="token operator">*</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> h<span class="token operator">*</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">*</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token keyword">float</span> s <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">-</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> t <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span>y<span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>m2<span class="token operator">+</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">float</span> a <span class="token operator">=</span> m2<span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token operator">+</span>s<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token operator">+</span>s<span class="token punctuation">)</span> <span class="token operator">+</span> q<span class="token punctuation">.</span>y<span class="token operator">*</span>q<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
	<span class="token keyword">float</span> b <span class="token operator">=</span> m2<span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token operator">+</span><span class="token number">0.5</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token operator">+</span><span class="token number">0.5</span><span class="token operator">*</span>t<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span>y<span class="token operator">-</span>m2<span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>y<span class="token operator">-</span>m2<span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">float</span> d2 <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>y<span class="token punctuation">,</span><span class="token operator">-</span>q<span class="token punctuation">.</span>x<span class="token operator">*</span>m2<span class="token operator">-</span>q<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span> <span class="token operator">?</span> <span class="token number">0.0</span> <span class="token operator">:</span> <span class="token function">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// recover 3D and scale, and add sign</span>
    <span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>d2<span class="token operator">+</span>q<span class="token punctuation">.</span>z<span class="token operator">*</span>q<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token operator">/</span>m2 <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>z<span class="token punctuation">,</span><span class="token operator">-</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// la,lb=semi axis, h=height, ra=corner</span>
<span class="token keyword">float</span> <span class="token function">sdRhombus</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">float</span> la<span class="token punctuation">,</span> <span class="token keyword">float</span> lb<span class="token punctuation">,</span> <span class="token keyword">float</span> h<span class="token punctuation">,</span> <span class="token keyword">float</span> ra<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    p <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> b <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>la<span class="token punctuation">,</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> f <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token function">ndot</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span>b<span class="token operator">-</span><span class="token number">2.0</span><span class="token operator">*</span>p<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">dot</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">vec2</span> q <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xz<span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span>b<span class="token operator">*</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">-</span>f<span class="token punctuation">,</span><span class="token number">1.0</span><span class="token operator">+</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">sign</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">*</span>b<span class="token punctuation">.</span>y<span class="token operator">+</span>p<span class="token punctuation">.</span>z<span class="token operator">*</span>b<span class="token punctuation">.</span>x<span class="token operator">-</span>b<span class="token punctuation">.</span>x<span class="token operator">*</span>b<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">-</span>ra<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token operator">-</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span>q<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdHorseshoe</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> c<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> r<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> le<span class="token punctuation">,</span> <span class="token keyword">vec2</span> w <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    p<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> l <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>xy <span class="token operator">=</span> <span class="token keyword">mat2</span><span class="token punctuation">(</span><span class="token operator">-</span>c<span class="token punctuation">.</span>x<span class="token punctuation">,</span> c<span class="token punctuation">.</span>y<span class="token punctuation">,</span> 
              c<span class="token punctuation">.</span>y<span class="token punctuation">,</span> c<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token operator">*</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>xy <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token operator">&gt;</span><span class="token number">0.0</span> <span class="token operator">||</span> p<span class="token punctuation">.</span>x<span class="token operator">&gt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">?</span>p<span class="token punctuation">.</span>x<span class="token operator">:</span>l<span class="token operator">*</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token operator">-</span>c<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">&gt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">?</span>p<span class="token punctuation">.</span>y<span class="token operator">:</span>l <span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>xy <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span><span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token operator">-</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token keyword">vec2</span><span class="token punctuation">(</span>le<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">vec2</span> q <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token operator">-</span> w<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span>d<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdU</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> r<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> le<span class="token punctuation">,</span> <span class="token keyword">vec2</span> w <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    p<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token operator">&gt;</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">-</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>y <span class="token operator">=</span> p<span class="token punctuation">.</span>y <span class="token operator">-</span> le<span class="token punctuation">;</span>
    <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> q <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>k<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">-</span>k <span class="token operator">:</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xy<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">-</span> w<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>x<span class="token punctuation">,</span>q<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//------------------------------------------------------------------</span>

<span class="token keyword">vec2</span> <span class="token function">opU</span><span class="token punctuation">(</span> <span class="token keyword">vec2</span> d1<span class="token punctuation">,</span> <span class="token keyword">vec2</span> d2 <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>d1<span class="token punctuation">.</span>x<span class="token operator">&lt;</span>d2<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">?</span> d1 <span class="token operator">:</span> d2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//------------------------------------------------------------------</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ZERO</span> <span class="token expression"><span class="token number">0</span></span></span>

<span class="token comment">//------------------------------------------------------------------</span>

<span class="token keyword">vec2</span> <span class="token function">map</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> pos <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> res <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> pos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// bounding box</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">sdBox</span><span class="token punctuation">(</span> pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">&lt;</span>res<span class="token punctuation">.</span>x <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdSphere</span><span class="token punctuation">(</span>    pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.25</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">26.9</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	  res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdRhombus</span><span class="token punctuation">(</span>  <span class="token punctuation">(</span>pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xzy<span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.04</span><span class="token punctuation">,</span> <span class="token number">0.08</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">17.0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// bounding box</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">sdBox</span><span class="token punctuation">(</span> pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.35</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">2.5</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">&lt;</span>res<span class="token punctuation">.</span>x <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
	res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdCappedTorus</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.30</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.866025</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">25.0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdBoxFrame</span><span class="token punctuation">(</span>    pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.025</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16.9</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdCone</span><span class="token punctuation">(</span>        pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.45</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.6</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.45</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">55.0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdCappedCone</span><span class="token punctuation">(</span>  pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.1</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">13.67</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdSolidAngle</span><span class="token punctuation">(</span>  pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.00</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">0.4</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">49.13</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// bounding box</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">sdBox</span><span class="token punctuation">(</span> pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.35</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">2.5</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">&lt;</span>res<span class="token punctuation">.</span>x <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
	res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdTorus</span><span class="token punctuation">(</span>      <span class="token punctuation">(</span>pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.30</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xzy<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0.05</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">7.1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdBox</span><span class="token punctuation">(</span>         pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3.0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdCapsule</span><span class="token punctuation">(</span>     pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.00</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.1</span>  <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">31.9</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdCylinder</span><span class="token punctuation">(</span>    pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.15</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8.0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdHexPrism</span><span class="token punctuation">(</span>    pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.05</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">18.4</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// bounding box</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">sdBox</span><span class="token punctuation">(</span> pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.35</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.35</span><span class="token punctuation">,</span><span class="token number">0.35</span><span class="token punctuation">,</span><span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>res<span class="token punctuation">.</span>x <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
	res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdPyramid</span><span class="token punctuation">(</span>    pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.6</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">13.56</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdOctahedron</span><span class="token punctuation">(</span> pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.15</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.35</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">23.56</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdTriPrism</span><span class="token punctuation">(</span>   pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.15</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.05</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">43.5</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdEllipsoid</span><span class="token punctuation">(</span>  pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">43.17</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdHorseshoe</span><span class="token punctuation">(</span>  pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">1.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">1.3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.03</span><span class="token punctuation">,</span><span class="token number">0.08</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">11.5</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// bounding box</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">sdBox</span><span class="token punctuation">(</span> pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.35</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">2.5</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">&lt;</span>res<span class="token punctuation">.</span>x <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdOctogonPrism</span><span class="token punctuation">(</span>pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">51.8</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdCylinder</span><span class="token punctuation">(</span>    pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">0.14</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.35</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.08</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">31.2</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdCappedCone</span><span class="token punctuation">(</span>  pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">0.09</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.40</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">46.1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdRoundCone</span><span class="token punctuation">(</span>   pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.35</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">51.7</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">opU</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">sdRoundCone</span><span class="token punctuation">(</span>   pos<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">0.20</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.3</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">37.0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec2</span> <span class="token function">iBox</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> ro<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> rd<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> rad <span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> m <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span>rd<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> n <span class="token operator">=</span> m<span class="token operator">*</span>ro<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> k <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token operator">*</span>rad<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> t1 <span class="token operator">=</span> <span class="token operator">-</span>n <span class="token operator">-</span> k<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> t2 <span class="token operator">=</span> <span class="token operator">-</span>n <span class="token operator">+</span> k<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">max</span><span class="token punctuation">(</span> <span class="token function">max</span><span class="token punctuation">(</span> t1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> t1<span class="token punctuation">.</span>y <span class="token punctuation">)</span><span class="token punctuation">,</span> t1<span class="token punctuation">.</span>z <span class="token punctuation">)</span><span class="token punctuation">,</span>
	             <span class="token function">min</span><span class="token punctuation">(</span> <span class="token function">min</span><span class="token punctuation">(</span> t2<span class="token punctuation">.</span>x<span class="token punctuation">,</span> t2<span class="token punctuation">.</span>y <span class="token punctuation">)</span><span class="token punctuation">,</span> t2<span class="token punctuation">.</span>z <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec2</span> <span class="token function">raycast</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> ro<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> rd <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> res <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> tmin <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> tmax <span class="token operator">=</span> <span class="token number">20.0</span><span class="token punctuation">;</span>

    <span class="token comment">// raytrace floor plane</span>
    <span class="token keyword">float</span> tp1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token operator">-</span>ro<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">/</span>rd<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> tp1<span class="token operator">&gt;</span><span class="token number">0.0</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        tmax <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span> tmax<span class="token punctuation">,</span> tp1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
        res <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> tp1<span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//else return res;</span>
    
    <span class="token comment">// raymarch primitives   </span>
    <span class="token keyword">vec2</span> tb <span class="token operator">=</span> <span class="token function">iBox</span><span class="token punctuation">(</span> ro<span class="token operator">-</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rd<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">2.5</span><span class="token punctuation">,</span><span class="token number">0.41</span><span class="token punctuation">,</span><span class="token number">3.0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> tb<span class="token punctuation">.</span>x<span class="token operator">&lt;</span>tb<span class="token punctuation">.</span>y <span class="token operator">&amp;&amp;</span> tb<span class="token punctuation">.</span>y<span class="token operator">&gt;</span><span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span> tb<span class="token punctuation">.</span>x<span class="token operator">&lt;</span>tmax<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//return vec2(tb.x,2.0);</span>
        tmin <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>x<span class="token punctuation">,</span>tmin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmax <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>tb<span class="token punctuation">.</span>y<span class="token punctuation">,</span>tmax<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">float</span> t <span class="token operator">=</span> tmin<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">70</span> <span class="token operator">&amp;&amp;</span> t<span class="token operator">&lt;</span>tmax<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">vec2</span> h <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span> ro<span class="token operator">+</span>rd<span class="token operator">*</span>t <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">abs</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token number">0.0001</span><span class="token operator">*</span>t<span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span> 
                res <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span>h<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            t <span class="token operator">+=</span> h<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// https://iquilezles.org/articles/rmshadows</span>
<span class="token keyword">float</span> <span class="token function">calcSoftshadow</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> ro<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> rd<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> mint<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> tmax <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// bounding volume</span>
    <span class="token keyword">float</span> tp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.8</span><span class="token operator">-</span>ro<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">/</span>rd<span class="token punctuation">.</span>y<span class="token punctuation">;</span> <span class="token keyword">if</span><span class="token punctuation">(</span> tp<span class="token operator">&gt;</span><span class="token number">0.0</span> <span class="token punctuation">)</span> tmax <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span> tmax<span class="token punctuation">,</span> tp <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> res <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> t <span class="token operator">=</span> mint<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i<span class="token operator">=</span>ZERO<span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">24</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		<span class="token keyword">float</span> h <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span> ro <span class="token operator">+</span> rd<span class="token operator">*</span>t <span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token keyword">float</span> s <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">8.0</span><span class="token operator">*</span>h<span class="token operator">/</span>t<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> s <span class="token punctuation">)</span><span class="token punctuation">;</span>
        t <span class="token operator">+=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> h<span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> res<span class="token operator">&lt;</span><span class="token number">0.004</span> <span class="token operator">||</span> t<span class="token operator">&gt;</span>tmax <span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    res <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token operator">*</span>res<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">3.0</span><span class="token operator">-</span><span class="token number">2.0</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec3</span> <span class="token function">calcNormal</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> pos <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    <span class="token keyword">vec2</span> e <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.5773</span><span class="token operator">*</span><span class="token number">0.0005</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span> e<span class="token punctuation">.</span>xyy<span class="token operator">*</span><span class="token function">map</span><span class="token punctuation">(</span> pos <span class="token operator">+</span> e<span class="token punctuation">.</span>xyy <span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">+</span> 
					  e<span class="token punctuation">.</span>yyx<span class="token operator">*</span><span class="token function">map</span><span class="token punctuation">(</span> pos <span class="token operator">+</span> e<span class="token punctuation">.</span>yyx <span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">+</span> 
					  e<span class="token punctuation">.</span>yxy<span class="token operator">*</span><span class="token function">map</span><span class="token punctuation">(</span> pos <span class="token operator">+</span> e<span class="token punctuation">.</span>yxy <span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">+</span> 
					  e<span class="token punctuation">.</span>xxx<span class="token operator">*</span><span class="token function">map</span><span class="token punctuation">(</span> pos <span class="token operator">+</span> e<span class="token punctuation">.</span>xxx <span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">// inspired by tdhooper and klems - a way to prevent the compiler from inlining map() 4 times</span>
    <span class="token keyword">vec3</span> n <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i<span class="token operator">=</span>ZERO<span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">vec3</span> e <span class="token operator">=</span> <span class="token number">0.5773</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token operator">*</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>i<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        n <span class="token operator">+=</span> e<span class="token operator">*</span><span class="token function">map</span><span class="token punctuation">(</span>pos<span class="token operator">+</span><span class="token number">0.0005</span><span class="token operator">*</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
      <span class="token comment">//if( n.x+n.y+n.z&gt;100.0 ) break;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>    </span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">calcAO</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> pos<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> nor <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">float</span> occ <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> sca <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i<span class="token operator">=</span>ZERO<span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">float</span> h <span class="token operator">=</span> <span class="token number">0.01</span> <span class="token operator">+</span> <span class="token number">0.12</span><span class="token operator">*</span><span class="token keyword">float</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4.0</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span> pos <span class="token operator">+</span> h<span class="token operator">*</span>nor <span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        occ <span class="token operator">+=</span> <span class="token punctuation">(</span>h<span class="token operator">-</span>d<span class="token punctuation">)</span><span class="token operator">*</span>sca<span class="token punctuation">;</span>
        sca <span class="token operator">*=</span> <span class="token number">0.95</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> occ<span class="token operator">&gt;</span><span class="token number">0.35</span> <span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">3.0</span><span class="token operator">*</span>occ<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token operator">*</span>nor<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">checkersGradBox</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> p<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> dpdx<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> dpdy <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// filter kernel</span>
    <span class="token keyword">vec2</span> w <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>dpdx<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">abs</span><span class="token punctuation">(</span>dpdy<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.001</span><span class="token punctuation">;</span>
    <span class="token comment">// analytical integral (box filter)</span>
    <span class="token keyword">vec2</span> i <span class="token operator">=</span> <span class="token number">2.0</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">fract</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span>w<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">fract</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">0.5</span><span class="token operator">*</span>w<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>w<span class="token punctuation">;</span>
    <span class="token comment">// xor pattern</span>
    <span class="token keyword">return</span> <span class="token number">0.5</span> <span class="token operator">-</span> <span class="token number">0.5</span><span class="token operator">*</span>i<span class="token punctuation">.</span>x<span class="token operator">*</span>i<span class="token punctuation">.</span>y<span class="token punctuation">;</span>                  
<span class="token punctuation">}</span>

<span class="token keyword">vec3</span> <span class="token function">render</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> ro<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> rd<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> rdx<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> rdy <span class="token punctuation">)</span>
<span class="token punctuation">{</span> 
    <span class="token comment">// background</span>
    <span class="token keyword">vec3</span> col <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">max</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>y<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.3</span><span class="token punctuation">;</span>
    
    <span class="token comment">// raycast scene</span>
    <span class="token keyword">vec2</span> res <span class="token operator">=</span> <span class="token function">raycast</span><span class="token punctuation">(</span>ro<span class="token punctuation">,</span>rd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> t <span class="token operator">=</span> res<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
	<span class="token keyword">float</span> m <span class="token operator">=</span> res<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> m<span class="token operator">&gt;</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">vec3</span> pos <span class="token operator">=</span> ro <span class="token operator">+</span> t<span class="token operator">*</span>rd<span class="token punctuation">;</span>
        <span class="token keyword">vec3</span> nor <span class="token operator">=</span> <span class="token punctuation">(</span>m<span class="token operator">&lt;</span><span class="token number">1.5</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">calcNormal</span><span class="token punctuation">(</span> pos <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">vec3</span> ref <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span> rd<span class="token punctuation">,</span> nor <span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// material        </span>
        col <span class="token operator">=</span> <span class="token number">0.2</span> <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">*</span><span class="token function">sin</span><span class="token punctuation">(</span> m<span class="token operator">*</span><span class="token number">2.0</span> <span class="token operator">+</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">2.0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> ks <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span> m<span class="token operator">&lt;</span><span class="token number">1.5</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// project pixel footprint into the plane</span>
            <span class="token keyword">vec3</span> dpdx <span class="token operator">=</span> ro<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token punctuation">(</span>rd<span class="token operator">/</span>rd<span class="token punctuation">.</span>y<span class="token operator">-</span>rdx<span class="token operator">/</span>rdx<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec3</span> dpdy <span class="token operator">=</span> ro<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token punctuation">(</span>rd<span class="token operator">/</span>rd<span class="token punctuation">.</span>y<span class="token operator">-</span>rdy<span class="token operator">/</span>rdy<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">float</span> f <span class="token operator">=</span> <span class="token function">checkersGradBox</span><span class="token punctuation">(</span> <span class="token number">3.0</span><span class="token operator">*</span>pos<span class="token punctuation">.</span>xz<span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token operator">*</span>dpdx<span class="token punctuation">.</span>xz<span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token operator">*</span>dpdy<span class="token punctuation">.</span>xz <span class="token punctuation">)</span><span class="token punctuation">;</span>
            col <span class="token operator">=</span> <span class="token number">0.15</span> <span class="token operator">+</span> f<span class="token operator">*</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ks <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// lighting</span>
        <span class="token keyword">float</span> occ <span class="token operator">=</span> <span class="token function">calcAO</span><span class="token punctuation">(</span> pos<span class="token punctuation">,</span> nor <span class="token punctuation">)</span><span class="token punctuation">;</span>
        
		<span class="token keyword">vec3</span> lin <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// sun</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">vec3</span>  lig <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.6</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">vec3</span>  hal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span> lig<span class="token operator">-</span>rd <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> dif <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token function">dot</span><span class="token punctuation">(</span> nor<span class="token punctuation">,</span> lig <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//if( dif&gt;0.0001 )</span>
        	      dif <span class="token operator">*=</span> <span class="token function">calcSoftshadow</span><span class="token punctuation">(</span> pos<span class="token punctuation">,</span> lig<span class="token punctuation">,</span> <span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token number">2.5</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">float</span> spe <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span> <span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token function">dot</span><span class="token punctuation">(</span> nor<span class="token punctuation">,</span> hal <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  spe <span class="token operator">*=</span> dif<span class="token punctuation">;</span>
                  spe <span class="token operator">*=</span> <span class="token number">0.04</span><span class="token operator">+</span><span class="token number">0.96</span><span class="token operator">*</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">-</span><span class="token function">dot</span><span class="token punctuation">(</span>hal<span class="token punctuation">,</span>lig<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//spe *= 0.04+0.96*pow(clamp(1.0-sqrt(0.5*(1.0-dot(rd,lig))),0.0,1.0),5.0);</span>
            lin <span class="token operator">+=</span> col<span class="token operator">*</span><span class="token number">2.20</span><span class="token operator">*</span>dif<span class="token operator">*</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.30</span><span class="token punctuation">,</span><span class="token number">1.00</span><span class="token punctuation">,</span><span class="token number">0.70</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lin <span class="token operator">+=</span>     <span class="token number">5.00</span><span class="token operator">*</span>spe<span class="token operator">*</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.30</span><span class="token punctuation">,</span><span class="token number">1.00</span><span class="token punctuation">,</span><span class="token number">0.70</span><span class="token punctuation">)</span><span class="token operator">*</span>ks<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// sky</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">float</span> dif <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token number">0.5</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token operator">*</span>nor<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  dif <span class="token operator">*=</span> occ<span class="token punctuation">;</span>
            <span class="token keyword">float</span> spe <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> ref<span class="token punctuation">.</span>y <span class="token punctuation">)</span><span class="token punctuation">;</span>
                  spe <span class="token operator">*=</span> dif<span class="token punctuation">;</span>
                  spe <span class="token operator">*=</span> <span class="token number">0.04</span><span class="token operator">+</span><span class="token number">0.96</span><span class="token operator">*</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">+</span><span class="token function">dot</span><span class="token punctuation">(</span>nor<span class="token punctuation">,</span>rd<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//if( spe&gt;0.001 )</span>
                  spe <span class="token operator">*=</span> <span class="token function">calcSoftshadow</span><span class="token punctuation">(</span> pos<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> <span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token number">2.5</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            lin <span class="token operator">+=</span> col<span class="token operator">*</span><span class="token number">0.60</span><span class="token operator">*</span>dif<span class="token operator">*</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span><span class="token number">0.60</span><span class="token punctuation">,</span><span class="token number">1.15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lin <span class="token operator">+=</span>     <span class="token number">2.00</span><span class="token operator">*</span>spe<span class="token operator">*</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span><span class="token number">0.60</span><span class="token punctuation">,</span><span class="token number">1.30</span><span class="token punctuation">)</span><span class="token operator">*</span>ks<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// back</span>
        <span class="token punctuation">{</span>
        	<span class="token keyword">float</span> dif <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token function">dot</span><span class="token punctuation">(</span> nor<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">clamp</span><span class="token punctuation">(</span> <span class="token number">1.0</span><span class="token operator">-</span>pos<span class="token punctuation">.</span>y<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  dif <span class="token operator">*=</span> occ<span class="token punctuation">;</span>
        	lin <span class="token operator">+=</span> col<span class="token operator">*</span><span class="token number">0.55</span><span class="token operator">*</span>dif<span class="token operator">*</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// sss</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">float</span> dif <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">+</span><span class="token function">dot</span><span class="token punctuation">(</span>nor<span class="token punctuation">,</span>rd<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  dif <span class="token operator">*=</span> occ<span class="token punctuation">;</span>
        	lin <span class="token operator">+=</span> col<span class="token operator">*</span><span class="token number">0.25</span><span class="token operator">*</span>dif<span class="token operator">*</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.00</span><span class="token punctuation">,</span><span class="token number">1.00</span><span class="token punctuation">,</span><span class="token number">1.00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
		col <span class="token operator">=</span> lin<span class="token punctuation">;</span>

        col <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span> col<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span><span class="token number">0.7</span><span class="token punctuation">,</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token operator">-</span><span class="token function">exp</span><span class="token punctuation">(</span> <span class="token operator">-</span><span class="token number">0.0001</span><span class="token operator">*</span>t<span class="token operator">*</span>t<span class="token operator">*</span>t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token function">clamp</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">mat3</span> <span class="token function">setCamera</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> ro<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> ta<span class="token punctuation">,</span> <span class="token keyword">float</span> cr <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">vec3</span> cw <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>ta<span class="token operator">-</span>ro<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">vec3</span> cp <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cos</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">vec3</span> cu <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span> <span class="token function">cross</span><span class="token punctuation">(</span>cw<span class="token punctuation">,</span>cp<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">vec3</span> cv <span class="token operator">=</span>          <span class="token punctuation">(</span> <span class="token function">cross</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span>cw<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span> cu<span class="token punctuation">,</span> cv<span class="token punctuation">,</span> cw <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">mainImage</span><span class="token punctuation">(</span> <span class="token keyword">out</span> <span class="token keyword">vec4</span> fragColor<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> fragCoord <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> mo <span class="token operator">=</span> u_mouse<span class="token punctuation">.</span>xy<span class="token operator">/</span>u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
	<span class="token keyword">float</span> time <span class="token operator">=</span> <span class="token number">32.0</span> <span class="token operator">+</span> u_time<span class="token operator">*</span><span class="token number">1.5</span><span class="token punctuation">;</span>

    <span class="token comment">// camera	</span>
    <span class="token keyword">vec3</span> ta <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.75</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> ro <span class="token operator">=</span> ta <span class="token operator">+</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token number">4.5</span><span class="token operator">*</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token operator">*</span>time <span class="token operator">+</span> <span class="token number">7.0</span><span class="token operator">*</span>mo<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">,</span> <span class="token number">4.5</span><span class="token operator">*</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token operator">*</span>time <span class="token operator">+</span> <span class="token number">7.0</span><span class="token operator">*</span>mo<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// camera-to-world transformation</span>
    <span class="token keyword">mat3</span> ca <span class="token operator">=</span> <span class="token function">setCamera</span><span class="token punctuation">(</span> ro<span class="token punctuation">,</span> ta<span class="token punctuation">,</span> <span class="token number">0.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">vec3</span> tot <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> m<span class="token operator">=</span>ZERO<span class="token punctuation">;</span> m<span class="token operator">&lt;</span>AA<span class="token punctuation">;</span> m<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> n<span class="token operator">=</span>ZERO<span class="token punctuation">;</span> n<span class="token operator">&lt;</span>AA<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// pixel coordinates</span>
        <span class="token keyword">vec2</span> o <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">float</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>AA<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
        <span class="token keyword">vec2</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2.0</span><span class="token operator">*</span><span class="token punctuation">(</span>fragCoord<span class="token operator">+</span>o<span class="token punctuation">)</span><span class="token operator">-</span>u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token operator">/</span>u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">;</span>


        <span class="token comment">// focal length</span>
        <span class="token keyword">const</span> <span class="token keyword">float</span> fl <span class="token operator">=</span> <span class="token number">2.5</span><span class="token punctuation">;</span>
        
        <span class="token comment">// ray direction</span>
        <span class="token keyword">vec3</span> rd <span class="token operator">=</span> ca <span class="token operator">*</span> <span class="token function">normalize</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>fl<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// ray differentials</span>
        <span class="token keyword">vec2</span> px <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2.0</span><span class="token operator">*</span><span class="token punctuation">(</span>fragCoord<span class="token operator">+</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span>u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token operator">/</span>u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token keyword">vec2</span> py <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2.0</span><span class="token operator">*</span><span class="token punctuation">(</span>fragCoord<span class="token operator">+</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span>u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token operator">/</span>u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token keyword">vec3</span> rdx <span class="token operator">=</span> ca <span class="token operator">*</span> <span class="token function">normalize</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>px<span class="token punctuation">,</span>fl<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">vec3</span> rdy <span class="token operator">=</span> ca <span class="token operator">*</span> <span class="token function">normalize</span><span class="token punctuation">(</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>py<span class="token punctuation">,</span>fl<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// render	</span>
        <span class="token keyword">vec3</span> col <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span> ro<span class="token punctuation">,</span> rd<span class="token punctuation">,</span> rdx<span class="token punctuation">,</span> rdy <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// gain</span>
        <span class="token comment">// col = col*3.0/(2.5+col);</span>
        
		<span class="token comment">// gamma</span>
        col <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span> col<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.4545</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        tot <span class="token operator">+=</span> col<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">AA<span class="token operator">&gt;</span><span class="token number">1</span></span></span>
    <span class="token punctuation">}</span>
    tot <span class="token operator">/=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>AA<span class="token operator">*</span>AA<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
    fragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span> tot<span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">mainImage</span><span class="token punctuation">(</span>gl_FragColor<span class="token punctuation">,</span>vUv <span class="token operator">*</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1)),s("h3",b,[n[13]||(n[13]=s("a",{class:"header-anchor",href:"#simpletruchetpattern","aria-hidden":"true"},"#",-1)),n[14]||(n[14]=a()),o(t,{to:"/markdown/example/simpleTruchetPattern.html"},{default:e(()=>n[12]||(n[12]=[a("simpleTruchetPattern")])),_:1})]),n[23]||(n[23]=p(`<div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code>
<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_position<span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> vUv<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_time<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_resolution<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_frame<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HPI</span> <span class="token expression"><span class="token number">1.57079632679</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">tiles</span> <span class="token expression"><span class="token number">10.0</span></span></span>

<span class="token keyword">float</span> <span class="token function">hash21</span><span class="token punctuation">(</span><span class="token keyword">in</span> <span class="token keyword">vec2</span> st<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//fract(x) \u83B7\u53D6x\u7684\u5C0F\u6570\u90E8\u5206</span>
    <span class="token comment">//dot(x,y)\u8FD4\u56DEx,y\u7684\u70B9\u79EF</span>
    <span class="token comment">//\u4E24\u4E2A\u5411\u91CFa = [a1, a2,\u2026, an]\u548Cb = [b1, b2,\u2026, bn]\u7684\u70B9\u79EF\u5B9A\u4E49\u4E3A\uFF1A</span>
    <span class="token comment">// a\xB7b=a1b1+a2b2+\u2026\u2026+anbn\u3002  </span>
    <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>xy<span class="token punctuation">,</span><span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">12.9898</span><span class="token punctuation">,</span><span class="token number">78.233</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">43758.5453123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sdfTile</span><span class="token punctuation">(</span><span class="token keyword">in</span> <span class="token keyword">vec2</span> p<span class="token punctuation">,</span><span class="token keyword">float</span> r <span class="token punctuation">,</span> <span class="token keyword">float</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> rot<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    p <span class="token operator">-=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    <span class="token comment">//mat2 2*2 \u6D6E\u70B9\u77E9\u9635</span>
    p <span class="token operator">*=</span> <span class="token keyword">mat2</span><span class="token punctuation">(</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>rot<span class="token punctuation">)</span><span class="token operator">*</span>HPI<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>rot<span class="token punctuation">)</span><span class="token operator">*</span>HPI<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>rot<span class="token punctuation">)</span><span class="token operator">*</span>HPI<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>rot<span class="token punctuation">)</span><span class="token operator">*</span>HPI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p <span class="token operator">+=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">length</span><span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span>r<span class="token punctuation">)</span><span class="token operator">-</span>t<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">vec2</span> <span class="token function">stepPoint</span><span class="token punctuation">(</span><span class="token keyword">vec2</span> p <span class="token punctuation">,</span> <span class="token keyword">float</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token function">floor</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token operator">/</span>c<span class="token punctuation">,</span><span class="token function">floor</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y <span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token operator">/</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">mainImage</span><span class="token punctuation">(</span> <span class="token keyword">out</span> <span class="token keyword">vec4</span> fragColor<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> fragCoord <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> uv <span class="token operator">=</span> fragCoord<span class="token operator">/</span>u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    uv<span class="token operator">-=</span><span class="token number">0.5</span><span class="token punctuation">;</span>
    uv<span class="token punctuation">.</span>x<span class="token operator">*=</span>u_resolution<span class="token punctuation">.</span>x<span class="token operator">/</span>u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    uv<span class="token operator">+=</span><span class="token number">0.5</span><span class="token punctuation">;</span>
    uv<span class="token punctuation">.</span>x<span class="token operator">+=</span> u_time<span class="token operator">*</span><span class="token number">0.1</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> px <span class="token operator">=</span> tiles<span class="token operator">/</span>u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> titleUv <span class="token operator">=</span> <span class="token function">fract</span><span class="token punctuation">(</span>uv<span class="token operator">*</span>tiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> tile <span class="token operator">=</span> <span class="token function">hash21</span><span class="token punctuation">(</span><span class="token function">stepPoint</span><span class="token punctuation">(</span>uv<span class="token punctuation">,</span>tiles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> col <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span>px<span class="token punctuation">,</span><span class="token function">sdfTile</span><span class="token punctuation">(</span>titleUv<span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.05</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    fragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>col<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">mainImage</span><span class="token punctuation">(</span>gl_FragColor<span class="token punctuation">,</span>vUv <span class="token operator">*</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1)),s("h3",f,[n[16]||(n[16]=s("a",{class:"header-anchor",href:"#waveprint","aria-hidden":"true"},"#",-1)),n[17]||(n[17]=a()),o(t,{to:"/markdown/example/wavePrint.html"},{default:e(()=>n[15]||(n[15]=[a("wavePrint")])),_:1})]),n[24]||(n[24]=p(`<div class="language-glsl ext-glsl line-numbers-mode"><pre class="language-glsl"><code><span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_position<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_time<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_resolution<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> uv <span class="token operator">=</span> gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">/</span>u_resolution<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> col <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">*</span><span class="token function">cos</span><span class="token punctuation">(</span>u_time<span class="token operator">+</span>uv<span class="token punctuation">.</span>xyx<span class="token operator">+</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> cd <span class="token operator">=</span> <span class="token number">40.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> lw <span class="token operator">=</span> <span class="token number">500.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> a <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>u_time<span class="token operator">/</span><span class="token number">20.0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> r <span class="token operator">=</span> <span class="token function">ceil</span><span class="token punctuation">(</span>uv<span class="token punctuation">.</span>x<span class="token operator">*</span>cd<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">ceil</span><span class="token punctuation">(</span>uv<span class="token punctuation">.</span>y<span class="token operator">*</span>cd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> col2 <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span> <span class="token function">sin</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uv<span class="token punctuation">.</span>x<span class="token operator">*</span>lw<span class="token operator">*</span><span class="token function">sin</span><span class="token punctuation">(</span>r<span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>uv<span class="token punctuation">.</span>y<span class="token operator">*</span>lw<span class="token operator">*</span><span class="token function">cos</span><span class="token punctuation">(</span>r<span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token operator">-</span>col<span class="token punctuation">.</span>rrr<span class="token operator">-</span>col2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1))])}var h=c(k,[["render",y],["__file","exampleGlslCollect.html.vue"]]);export{h as default};
//# sourceMappingURL=exampleGlslCollect.html.1fd29aed.js.map
